#From 1acd4f78d122b759a129caac2daf19e1d4915f69 Mon Sep 17 00:00:00 2001
#From: erratic <erratic@laptop.paigeat.info>
#Date: Fri, 3 Oct 2014 20:22:33 +0300
#Subject: [PATCH] brr's patch

#---
# .CHANGES.NEW             |  24 +-
# .RELEASE.NOTES           | 114 +------
# Config                   |  52 +++
# _README.txt              |  59 ++++
# badwords.all.conf        |  35 ++
# config.settings          |   3 +
# configure                |  77 +++++
# gaymircd.conf            | 868 +++++++++++++++++++++++++++++++++++++++++++++++
# include/config.h         |  16 +-
# include/dynconf.h        |   5 +
# include/h.h              |   7 +
# include/msg.h            |   5 +
# include/numeric.h        |   8 +
# include/struct.h         |  37 +-
# ircd.motd                |   7 +
# src/api-isupport.c       |   3 +
# src/charsys.c            |  11 +-
# src/extbans.c            |   2 +-
# src/modules/Makefile.in  |   9 +-
# src/modules/l_commands.c |  22 ++
# src/modules/m_chghost.c  |   3 +-
# src/modules/m_chgident.c |   5 +-
# src/modules/m_codepage.c | 196 +++++++++++
# src/modules/m_mode.c     |   8 +-
# src/modules/m_nick.c     |  34 +-
# src/modules/m_server.c   |   7 +
# src/modules/m_sethost.c  |   6 +-
# src/modules/m_setident.c |   8 +-
# src/modules/m_stats.c    |  30 +-
# src/modules/m_whois.c    |   6 +
# src/s_bsd.c              |  43 +++
# src/s_conf.c             | 136 ++++++++
# src/s_err.c              |   8 +
# src/s_serv.c             |  11 +-
# src/send.c               | 106 ++++++
# unrealmotdconvert.pl     |  79 +++++
# 36 files changed, 1876 insertions(+), 174 deletions(-)
# create mode 100755 _README.txt
# create mode 100755 badwords.all.conf
# create mode 100755 config.settings
# create mode 100755 gaymircd.conf
# create mode 100755 ircd.motd
# create mode 100755 src/modules/m_codepage.c
# create mode 100755 unrealmotdconvert.pl

diff --git a/.CHANGES.NEW b/.CHANGES.NEW
index 8f5e628..9be7916 100644
--- a/.CHANGES.NEW
+++ b/.CHANGES.NEW
@@ -1,20 +1,18 @@
 
- _   _                      _ ___________  _____     _
-| | | |                    | |_   _| ___ \/  __ \   | |
-| | | |_ __  _ __ ___  __ _| | | | | |_/ /| /  \/ __| |
-| | | | '_ \| '__/ _ \/  _ | | | | |    / | |    /  _ |
-| |_| | | | | | |  __/ (_| | |_| |_| |\ \ | \__/\ (_| |
- \___/|_| |_|_|  \___|\__,_|_|\___/\_| \_| \____/\__,_|
-
-                               Configuration Program
+  _____      __     __        _____ _____   _____    _ 
+ / ____|   /\\ \   / /       |_   _|  __ \ / ____|  | |
+| |  __   /  \\ \_/ / __ ___   | | | |__) | |     __| |
+| | |_ | / /\ \\   / '_ ` _ \  | | |  _  /| |    / _` |
+| |__| |/ ____ \| || | | | | |_| |_| | \ \| |___| (_| |
+ \_____/_/    \_\_||_| |_| |_|_____|_|  \_\\_____\__,_|
+                                                       
                                 for Unreal3.2.9
                                     
-This program will help you to compile your IRC server, and ask you
+This program will help you to compile your mIRC server, and ask you
 questions regarding the compile-time settings of it during the process. 
 regarding the setup of it, during the process.
 
-If you have problems regarding the setup & compile, read Unreal.nfo to get
-more information on where to get help. Please, before running this setup,
-read the documentation in the "doc" folder. Docs are also avail online @
-http://www.unrealircd.com/unreal32docs.html
+If you have problems regarding the setup & compile, read _README.txt to get
+more information on where to get help. Docs are also avail online @
+http://berryx.com/GAYmIRCd/
 
diff --git a/.RELEASE.NOTES b/.RELEASE.NOTES
index a719d25..c79785b 100644
--- a/.RELEASE.NOTES
+++ b/.RELEASE.NOTES
@@ -1,117 +1,5 @@
 Unreal3.2.9 Release Notes
 ==========================
 
-==[ GENERAL INFORMATION ]==
-- If you are upgrading on *NIX, make sure you run 'make clean' and './Config'
-  first, before doing 'make'
-- The official UnrealIRCd documentation is doc/unreal32docs.html
-  online version at: http://www.vulnscan.org/UnrealIRCd/unreal32docs.html
-  FAQ: http://www.vulnscan.org/UnrealIRCd/faq/
-  Read them before asking for help.
-- Report bugs at http://bugs.unrealircd.org/
-- When upgrading a network, we assume you are upgrading from the previous
-  version (3.2.8/3.2.8.1). Upgrading from 3.2.6 or 3.2.7 should also be no problem.
-- The purpose of the sections below (NEW, CHANGED, MINOR, etc) is to be a SUMMARY
-  of the changes in this release. There have been 160+ changes, twice as much
-  as usual for a release, hence this summary is a bit long too.
-  For the FULL list of changes, see the Changelog.
-- If you previously used CVS to access the development version of UnrealIRCd,
-  you now need to use Mercurial, see see http://www.unrealircd.com/hgmove
-
-==[ NEW ]==
-- Extban ~j: this only prevents a user from joining, once in he can speak freely.
-- Extban ~R:<nick>: this ban only matches if <nick> is a registered user (has
-  identified to services). Especially useful in cases like: +e ~R:TrustedUser.
-- Stacked Extended Bans:
-  - Extbans are now split in two groups:
-    - Ones that specify which user actions are affected (group 1):
-      ~q (quiet), ~n (nick change), ~j (join)
-    - Ones that introduce new criteria that can be used (group 2):
-      ~c (channel), ~r (realname), ~R (registered)
-  - With stacked extbans you can combine an extban of the first group with the second
-    For example: ~q:~c:#lamers would quiet all users who are also in #lamers
-- Extended Invex: very much like extended bans, but for +I (Invite Exception).
-  Currently supported are: ~c (channel, ~r (realname) and ~R (registered) [=group 2]
-  Possible useful uses are setting a channel +i (invite only) and then setting
-  +I ~c:#trustedchan (or even: +I ~c:+#trustedchan) while still retaining the ability
-  to easily ban users through +b.
-- Channel Mode +Z: indicates whether a channel is 'secure' or not.
-  This channel mode works in conjunction with +z (lower case z).
-  While +z (normally) prevents new non-SSL users from joining, sometimes they
-  can still join, like when after a netsplit the channels merge again.
-  When all users on the channel are connected through SSL, the channel is set +Z
-  by the server. Whenever an insecure user joins, the channel is put -Z.
-- Remote MOTD support: you can now specify an URL instead of a file
-- Automatic installation of curl (w/c-ares) if you answer 'Yes' to remote includes
-- One can now rehash ALL servers with the command '/REHASH -global'. This can be
-  particularly useful if you use remote includes or MOTD's. NetAdmin only command.
-- files { } block by which you can configure the location of the tune file, pid, etc
-- STARTTLS: On an IRCd compiled with SSL support this allows a client to start a SSL
-  session on a regular non-SSL port (like 6667). Only supported by a few IRC clients.
-  Can be disabled by setting set::ssl::options::no-starttls
-- set::uhnames: this allows one to turn UHNAMES off ('no'), which can be a good idea
-  if you have channels with more than 1000 users, as otherwise the nicklist can take
-  several seconds to load. Defaults to on ('yes').
-- IPv6 clones detection support: allow::ipv6-clone-mask determines the number of bits
-  used when comparing two IPv6 addresses to determine if allow::maxperip is exceeded.
-  This allows an admin to recognize that most IPv6 blocks are allocated to individuals,
-  who might each get a /64 IPv6 block. set::default-ipv6-clone-mask defaults to 64 and
-  provides default value for the allow blocks.
-- The m_nopost module is now part of Unreal: this defends against the Firefox/
-  Javascript 'XPS attack' which uses HTTP POST to create dummy IRC bots.
-- There have also been some behavior changes, which can be considered NEW, see
-  next section (CHANGED).
-
-==[ CHANGED ]==
-- Channel Mode +z: due to the +z/+Z changes, some things have changed:
-  - +z can now be set even when insecure users are present
-    (the channel will then be set +Z when the last insecure user leaves)
-  - An oper previously had to invite himself and then join the channel
-    with the key 'override' to set -z. This is no longer needed.
-    The channel stays +z, but will be set -Z when the oper joins.
-- Remote includes: if a remote include fails to load (eg: webserver down) then
-  the most recent (cached) version of that remote include will be used, and the
-  IRCd will still boot and be able to REHASH. This means it is now 'safe' to
-  use remote includes on a network, without risking problems like unable to
-  rehash in case of webserver problems.
-- set::level-on-join now supports voice/halfop/protect/owner
-- Backslashes (\) in MOTD/RULES files are no longer considered special, this
-  might mean that you have to change some escaped backslashes (\\) to \.
-- '/REHASH -motd' really rehashes ALL MOTD/OPERMOTD/BOTMOTD/RULES files, both
-  the 'normal' files and the ones in tld { } blocks.
-- The 'Compile as hub/leaf' choice is now gone, as it didn't do anything.
-- Better document 'sslclientcert' in the Oper Block documentation.
-  This allows one to authenticate against a SSL certificate for /OPER, instead
-  of using a password.
-
-==[ MAJOR BUGS FIXED ]==
-- If you have autoconnect with a low connfreq, previously you often risked getting
-  'Server exists' errors and 'breaking' the network. Now, the server handshake has
-  been redesigned which means this will no longer happen. You can now safely have
-  a low connfreq of - for example - 10 seconds.
-- Windows: 'Permission denied' errors when starting Unreal
-- A crash on some new Linux systems when replacing .so files
-- Solaris & QNX: Compile problems
-- IPv6: admins no longer have to tweak sysctl, like on FreeBSD & newer Linux systems
-- IPv6: IPv4 ip's in link::bind-ip did not work properly which made the IRCd either
-  not bind to the correct IP, or - like on FreeBSD - made it unable to link at all.
-- A very rare crash on outgoing connect
-
-==[ MINOR BUGS FIXED ]==
-- autoconnect not working if TS offset was negative (for the duration of the offset)
-- CGI:IRC & IPv6: sometimes a users' IP was incorrectly formatted, causing 'ghosts'
-- Mac OS X: permission problems
-- Several installation issues with curl
-- SSL: No more 'Underlying syscall error', the actual error is now shown
-- And many more... see Changelog
-
-==[ KNOWN ISSUES ]==
-- Regexes: Be careful with backreferences (\1, etc), certain regexes can slow the
-  IRCd down considerably and even bring it to a near-halt. In the spamfilter user
-  target it's usually safe though. Slow spamfilter detection can help prevent the
-  slowdown/freeze, but might not work in worst-case scenario's.
-- Regexes: Possessive quantifiers such as, for example, "++" (not to be confused
-  with "+") are not safe to use, they can easily freeze the IRCd.
-
-==[ ADDITIONAL INFO ]==
 * See Changelog for more details
+
diff --git a/Config b/Config
index 222895f..c43221a 100755
--- a/Config
+++ b/Config
@@ -62,6 +62,13 @@ else
 ARG="$ARG--enable-ziplinks=$ZIPLINKSDIR "
 fi
 fi
+if [ "$ICONV" = "1" ] ; then
+if test x"$ICONVDIR" = "x" ; then
+ARG="$ARG--enable-iconv "
+else
+ARG="$ARG--enable-iconv=$ICONVDIR "
+fi
+fi
 if [ "$REMOTEINC" = "1" ] ; then
 ARG="$ARG--enable-libcurl=$CURLDIR "
 fi
@@ -325,6 +332,8 @@ BUFFERPOOL="18"
 MAXCONNECTIONS="1024"
 INET6=""
 REMOTEINC=""
+ICONV=""
+ICONVDIR=""
 CURLDIR=""
 PREFIXAQ="1"
 SHOWLISTMODES="1"
@@ -827,6 +836,49 @@ done
 
 TEST=""
 while [ -z "$TEST" ] ; do
+    if [ "$ICONV" = "1" ] ; then
+        TEST="Yes"
+    else
+        TEST="No"
+    fi
+    echo ""
+    echo "Do you want to enable iconv (codepage) support?"
+    echo $n "[$TEST] -> $c"
+        read cc
+    if [ -z "$cc" ] ; then
+        cc=$TEST
+    fi
+    case "$cc" in
+        [Yy]*)
+	    ICONV="1"
+	    ;;
+	[Nn]*)
+	    ICONV=""
+	    ;;
+	*)
+	    echo ""
+	    echo "You must enter either Yes or No"
+	    TEST=""
+	    ;;
+    esac
+done
+
+if [ "$ICONV" = "1" ] ; then
+TEST=""
+echo ""
+echo "If you know the path to iconv on your system, enter it here. If not"
+echo "leave this blank"
+echo $n "[$TEST] -> $c"
+    read cc
+if [ -z "$cc" ] ; then
+    ICONVDIR=""
+else
+    ICONVDIR=`eval echo $cc` # modified
+fi
+fi
+
+TEST=""
+while [ -z "$TEST" ] ; do
     TEST="$LISTEN_SIZE"
     echo ""
     echo "What listen() backlog value do you wish to use?  Some older servers"
diff --git a/_README.txt b/_README.txt
new file mode 100755
index 0000000..87fe011
--- /dev/null
+++ b/_README.txt
@@ -0,0 +1,59 @@
+ï»¿/!\ warez from http://berryx.com/GAYmIRCd/ only /!\
+
+GAYmIRCd 12.02.04 FIXED for Unreal 3.2.9
+an unreal mod based on [nig]nigga's nigircd http://ngr.bz/nigircd.tar.gz
+
+YOU SHOULD ONLY HAVE:
+patched files: | .CHANGES.NEW | .RELEASE.NOTES | Config | configure | config.h | dynconf.h | h.h | msg.h | numeric.h | struct.h | api-isupport.c | charsys.c | extbans.c | s_bsd.c | s_conf.c | s_err.c | s_serv.c | send.c | l_commands.c | m_chghost.c | m_chgident.c | m_mode.c | m_nick.c | m_server.c | m_sethost.c | m_setident.c | m_stats.c | m_whois.c | Makefile.in
+new files: | _README.txt | badwords.all.conf | config.settings | gaymircd.conf | ircd.motd | unrealmotdconvert.pl | m_codepage.c 
+
+NEW IN THIS VERSION:
+- minor .conf fixes
+- patched ABbackdoor
+- upd8 some dox
+
+FEATURES:
+- easier to set up than unrealmircd
+- forces badword replacing network-wide(chan/priv) (if badwords are specified)
+- allows connecting with color/utf-8 idents and nicks
+- allows /sethost /setident /chghost /chgident to apply color/utf-8 idents and hosts :3
+- now able to link with other servers running GAYmIRCd!
+- raises limits for MAXTARGETS, TARGET_DELAY, HOSTLEN, NICKLEN, USERLEN, REALLEN, TOPICLEN, CHANNELLEN, KEYLEN, LINKLEN and limits for nick changes and max channels
+- removes fake lag for everyone and is able to handle more floods
+- removes useless/rude modes: +S +c +j +f (STRIP, NOCOLOR, JOINTHROTTLE, CHFLOODPROT)
+- includes a colored MOTD converter to use ascii as the motd
+- includes state of the art security/privacy options such as forcing spoof protection, disabling logging,
+    disabling dcc, preventing snomasks and stats use, flat map, hiding scum, anti spam measures etc
+- much more :} including glitches and stuff
+
+STILL TODO (note to self):
+1) maybe include some modules like sanick and sendraw
+2) more customizable, thru conf
+3) maybe try a version which requires at least 1 normal character in nickname, and strips other characters wen doing things, e.g. services. meaning nobody can steal nicks by adding utf8 characters, the stripped nick is what counts, and you can just stylize it however u want?
+4) also sending stripped nicknames to linked servers, maybe being able to link to unmodded servers.
+5) fix nickname flooding for non-opers
+6) clean up conf
+7) do that other thing .. 
+
+HOW TO INSTALLATION:
+0) get http://www.unrealircd.com/downloads/Unreal3.2.9.tar.gz
+1) compiling. assuming ur in ~/
+	- tar xvf Unreal3.2.9.tar.gz
+	- mv Unreal3.2/ Unreal3.3/
+	- tar xvf GAYmIRCd_12.02.04.tar.gz
+	- cd Unreal3.3/
+	- ./Config (not ./configure) (OMPORTANT: make sure iconv(codepage) is selected everytime)
+	- make clean all
+	*compiling done :D*
+2) 	mv gaymircd.conf unrealircd.conf
+	    and then edit it
+	OR
+	use your own conf but search gaymircd.conf for all instances of `GAYMIRCD' as they are changes u should make
+3) remove badwords.* lines from ur conf and/or empty the badwords.* files *IF* you wont be replacing badwords
+4) make a colored MOTD out of ascii or smth
+	move your new colored motd to old.motd
+	- perl unrealmotdconvert.pl old.motd ircd.motd 
+5) done :D
+	- ./unreal start
+
+(c) berry 2010-2012
\ No newline at end of file
diff --git a/badwords.all.conf b/badwords.all.conf
new file mode 100755
index 0000000..24ba167
--- /dev/null
+++ b/badwords.all.conf
@@ -0,0 +1,35 @@
+/*  
+ Unreal Internet Relay Chat Daemon
+ Copyright (C) Carsten V. Munk 2000
+
+ NOTE: Those words are not meant to insult you (the user)
+       but is meant to be a list of words so that the +G channel/user mode 
+       will work properly. You can easily modify this file at your will.
+       If you got words to add to this file, please mail badword messages@tspre.org
+
+ 
+
+
+
+ 
+                This is some filling space, scroll down to see the words
+
+ 
+
+
+ 
+
+
+ 
+
+
+ 
+
+
+ 
+
+
+*/
+
+/* badword all { word "*gay*"; replace "azaleas"; }; */
+/* badword all { word "gay"; }; */
diff --git a/config.settings b/config.settings
new file mode 100755
index 0000000..9b7b444
--- /dev/null
+++ b/config.settings
@@ -0,0 +1,3 @@
+INET6="1"
+CRYPTOIRCD="1"
+ICONV="1"
\ No newline at end of file
diff --git a/configure b/configure
index 4c2b7f1..203c9c6 100755
--- a/configure
+++ b/configure
@@ -73,6 +73,7 @@ else
   as_echo='sh -c $as_echo_body as_echo'
 fi
 
+
 # The user is always right.
 if test "${PATH_SEPARATOR+set}" != set; then
   PATH_SEPARATOR=:
@@ -83,6 +84,8 @@ if test "${PATH_SEPARATOR+set}" != set; then
 fi
 
 
+
+
 # IFS
 # We need space, tab and new line, in precisely that order.  Quoting is
 # there to prevent editors from complaining about space-tab.
@@ -135,6 +138,7 @@ export LANGUAGE
 # CDPATH.
 (unset CDPATH) >/dev/null 2>&1 && unset CDPATH
 
+
 if test "x$CONFIG_SHELL" = x; then
   as_bourne_compatible="if test -n \"\${ZSH_VERSION+set}\" && (emulate sh) >/dev/null 2>&1; then :
   emulate sh
@@ -165,6 +169,7 @@ as_fn_ret_success || { exitcode=1; echo as_fn_ret_success failed.; }
 as_fn_ret_failure && { exitcode=1; echo as_fn_ret_failure succeeded.; }
 if ( set x; as_fn_ret_success y && test x = \"\$1\" ); then :
 
+
 else
   exitcode=1; echo positional parameters were not saved.
 fi
@@ -1340,6 +1345,8 @@ Optional Features:
                           dynamic linking actually does anything or not)
   --enable-inet6          Make the IRCd support IPv6
   --enable-libcurl=DIR    enable libcurl (remote include) support
+  --enable-iconv=DIR      enable iconv (codepage changing) support
+
 
 Optional Packages:
   --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
@@ -4219,6 +4226,7 @@ if test "x$ac_cv_header_sys_param_h" = x""yes; then :
 
 $as_echo "#define PARAMH /**/" >>confdefs.h
 
+
 fi
 
 
@@ -4230,11 +4238,13 @@ $as_echo "#define STDLIBH /**/" >>confdefs.h
 fi
 
 
+
 ac_fn_c_check_header_mongrel "$LINENO" "stddef.h" "ac_cv_header_stddef_h" "$ac_includes_default"
 if test "x$ac_cv_header_stddef_h" = x""yes; then :
 
 $as_echo "#define STDDEFH /**/" >>confdefs.h
 
+
 fi
 
 
@@ -4243,9 +4253,11 @@ if test "x$ac_cv_header_sys_syslog_h" = x""yes; then :
 
 $as_echo "#define SYSSYSLOGH /**/" >>confdefs.h
 
+
 fi
 
 
+
 ac_fn_c_check_header_mongrel "$LINENO" "unistd.h" "ac_cv_header_unistd_h" "$ac_includes_default"
 if test "x$ac_cv_header_unistd_h" = x""yes; then :
 
@@ -4254,11 +4266,13 @@ $as_echo "#define UNISTDH /**/" >>confdefs.h
 fi
 
 
+
 ac_fn_c_check_header_mongrel "$LINENO" "string.h" "ac_cv_header_string_h" "$ac_includes_default"
 if test "x$ac_cv_header_string_h" = x""yes; then :
 
 $as_echo "#define STRINGH /**/" >>confdefs.h
 
+
 fi
 
 
@@ -4270,11 +4284,13 @@ $as_echo "#define STRINGSH /**/" >>confdefs.h
 fi
 
 
+
 ac_fn_c_check_header_mongrel "$LINENO" "malloc.h" "ac_cv_header_malloc_h" "$ac_includes_default"
 if test "x$ac_cv_header_malloc_h" = x""yes; then :
 
 $as_echo "#define MALLOCH <malloc.h>" >>confdefs.h
 
+
 fi
 
 
@@ -4283,14 +4299,17 @@ if test "x$ac_cv_header_sys_rusage_h" = x""yes; then :
 
 $as_echo "#define RUSAGEH /**/" >>confdefs.h
 
+
 fi
 
 
+
 ac_fn_c_check_header_mongrel "$LINENO" "glob.h" "ac_cv_header_glob_h" "$ac_includes_default"
 if test "x$ac_cv_header_glob_h" = x""yes; then :
 
 $as_echo "#define GLOBH /**/" >>confdefs.h
 
+
 fi
 
 
@@ -4304,6 +4323,7 @@ eval as_val=\$$as_ac_Header
 #define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
 _ACEOF
 
+
 fi
 
 done
@@ -4316,6 +4336,7 @@ else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
+
 int
 main ()
 {
@@ -4489,6 +4510,8 @@ fi
 
 
 
+
+
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether time.h and sys/time.h may both be included" >&5
 $as_echo_n "checking whether time.h and sys/time.h may both be included... " >&6; }
 if test "${ac_cv_header_time+set}" = set; then :
@@ -4587,6 +4610,7 @@ $as_echo "#define uid_t int" >>confdefs.h
 
 $as_echo "#define gid_t int" >>confdefs.h
 
+
 fi
 
 # The cast to long int works around a bug in the HP C Compiler
@@ -4600,6 +4624,7 @@ if test "${ac_cv_sizeof_short+set}" = set; then :
 else
   if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (short))" "ac_cv_sizeof_short"        "$ac_includes_default"; then :
 
+
 else
   if test "$ac_cv_type_short" = yes; then
      { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
@@ -4623,6 +4648,7 @@ cat >>confdefs.h <<_ACEOF
 _ACEOF
 
 
+
 # The cast to long int works around a bug in the HP C Compiler
 # version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
 # declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
@@ -4634,6 +4660,7 @@ if test "${ac_cv_sizeof_int+set}" = set; then :
 else
   if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (int))" "ac_cv_sizeof_int"        "$ac_includes_default"; then :
 
+
 else
   if test "$ac_cv_type_int" = yes; then
      { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
@@ -4657,6 +4684,8 @@ cat >>confdefs.h <<_ACEOF
 _ACEOF
 
 
+
+
 # The cast to long int works around a bug in the HP C Compiler
 # version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
 # declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
@@ -4668,6 +4697,7 @@ if test "${ac_cv_sizeof_long+set}" = set; then :
 else
   if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (long))" "ac_cv_sizeof_long"        "$ac_includes_default"; then :
 
+
 else
   if test "$ac_cv_type_long" = yes; then
      { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
@@ -4695,6 +4725,7 @@ if test "$ac_cv_sizeof_int" = 2 ; then
   ac_fn_c_check_type "$LINENO" "int16_t" "ac_cv_type_int16_t" "$ac_includes_default"
 if test "x$ac_cv_type_int16_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4706,6 +4737,7 @@ fi
   ac_fn_c_check_type "$LINENO" "u_int16_t" "ac_cv_type_u_int16_t" "$ac_includes_default"
 if test "x$ac_cv_type_u_int16_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4718,6 +4750,7 @@ elif test "$ac_cv_sizeof_short" = 2 ; then
   ac_fn_c_check_type "$LINENO" "int16_t" "ac_cv_type_int16_t" "$ac_includes_default"
 if test "x$ac_cv_type_int16_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4729,6 +4762,7 @@ fi
   ac_fn_c_check_type "$LINENO" "u_int16_t" "ac_cv_type_u_int16_t" "$ac_includes_default"
 if test "x$ac_cv_type_u_int16_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4744,6 +4778,7 @@ if test "$ac_cv_sizeof_int" = 4 ; then
   ac_fn_c_check_type "$LINENO" "int32_t" "ac_cv_type_int32_t" "$ac_includes_default"
 if test "x$ac_cv_type_int32_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4755,6 +4790,7 @@ fi
   ac_fn_c_check_type "$LINENO" "u_int32_t" "ac_cv_type_u_int32_t" "$ac_includes_default"
 if test "x$ac_cv_type_u_int32_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4767,6 +4803,7 @@ elif test "$ac_cv_sizeof_short" = 4 ; then
   ac_fn_c_check_type "$LINENO" "int32_t" "ac_cv_type_int32_t" "$ac_includes_default"
 if test "x$ac_cv_type_int32_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4778,6 +4815,7 @@ fi
   ac_fn_c_check_type "$LINENO" "u_int32_t" "ac_cv_type_u_int32_t" "$ac_includes_default"
 if test "x$ac_cv_type_u_int32_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4790,6 +4828,7 @@ elif test "$ac_cv_sizeof_long" = 4 ; then
   ac_fn_c_check_type "$LINENO" "int32_t" "ac_cv_type_int32_t" "$ac_includes_default"
 if test "x$ac_cv_type_int32_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4801,6 +4840,7 @@ fi
   ac_fn_c_check_type "$LINENO" "u_int32_t" "ac_cv_type_u_int32_t" "$ac_includes_default"
 if test "x$ac_cv_type_u_int32_t" = x""yes; then :
 
+
 else
 
 cat >>confdefs.h <<_ACEOF
@@ -4823,6 +4863,7 @@ if test "${ac_cv_sizeof_rlim_t+set}" = set; then :
 else
   if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (rlim_t))" "ac_cv_sizeof_rlim_t"        "$ac_includes_default"; then :
 
+
 else
   if test "$ac_cv_type_rlim_t" = yes; then
      { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
@@ -4900,6 +4941,7 @@ if ac_fn_c_try_run "$LINENO"; then :
   ac_cv_nonblocking=O_NONBLOCK
 else
 
+
 if test "$cross_compiling" = yes; then :
   { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
@@ -4938,6 +4980,7 @@ if ac_fn_c_try_run "$LINENO"; then :
   ac_cv_nonblocking=O_NDELAY
 else
 
+
 if test "$cross_compiling" = yes; then :
   { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
@@ -5097,6 +5140,8 @@ else
 fi
 
 
+
+
 # The Ultrix 4.2 mips builtin alloca declared by alloca.h only works
 # for constant arguments.  Useless!
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for working alloca.h" >&5
@@ -5227,6 +5272,7 @@ ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
 eval as_val=\$$as_ac_var
    if test "x$as_val" = x""yes; then :
 
+
 cat >>confdefs.h <<_ACEOF
 #define CRAY_STACKSEG_END $ac_func
 _ACEOF
@@ -5475,6 +5521,7 @@ if test "x$ac_cv_func__doprnt" = x""yes; then :
 
 $as_echo "#define HAVE_DOPRNT 1" >>confdefs.h
 
+
 fi
 
 fi
@@ -5491,6 +5538,7 @@ _ACEOF
 
 $as_echo "#define GETTIMEOFDAY /**/" >>confdefs.h
 
+
 else
   for ac_func in lrand48
 do :
@@ -5502,6 +5550,7 @@ _ACEOF
 
 $as_echo "#define LRADN48 /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5529,6 +5578,7 @@ _ACEOF
 
 $as_echo "#define TIMES_2 /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5651,6 +5701,7 @@ if ac_fn_c_try_run "$LINENO"; then :
   ac_cv_sigtype=POSIX
 else
 
+
 if test "$cross_compiling" = yes; then :
   { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
@@ -5704,10 +5755,12 @@ elif test "$ac_cv_sigtype" = "BSD"; then
 
 $as_echo "#define BSD_RELIABLE_SIGNALS /**/" >>confdefs.h
 
+
 else
 
 $as_echo "#define SYSV_UNRELIABLE_SIGNALS /**/" >>confdefs.h
 
+
 fi
 for ac_func in strtoken
 do :
@@ -5732,10 +5785,12 @@ if test "x$ac_cv_func_strtok" = x""yes; then :
 #define HAVE_STRTOK 1
 _ACEOF
 
+
 else
 
 $as_echo "#define NEED_STRTOK /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5747,10 +5802,12 @@ if test "x$ac_cv_func_strerror" = x""yes; then :
 #define HAVE_STRERROR 1
 _ACEOF
 
+
 else
 
 $as_echo "#define NEED_STRERROR /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5762,6 +5819,7 @@ if test "x$ac_cv_func_index" = x""yes; then :
 #define HAVE_INDEX 1
 _ACEOF
 
+
 else
 
 $as_echo "#define NOINDEX /**/" >>confdefs.h
@@ -5790,10 +5848,12 @@ if test "x$ac_cv_func_bcopy" = x""yes; then :
 #define HAVE_BCOPY 1
 _ACEOF
 
+
 else
 
 $as_echo "#define NEED_BCOPY /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5805,10 +5865,12 @@ if test "x$ac_cv_func_bcmp" = x""yes; then :
 #define HAVE_BCMP 1
 _ACEOF
 
+
 else
 
 $as_echo "#define NEED_BCMP /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5820,10 +5882,12 @@ if test "x$ac_cv_func_bzero" = x""yes; then :
 #define HAVE_BZERO 1
 _ACEOF
 
+
 else
 
 $as_echo "#define NEED_BZERO /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5837,6 +5901,7 @@ _ACEOF
 
 $as_echo "#define GOT_STRCASECMP /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5850,10 +5915,12 @@ if test "x$ac_cv_func_inet_addr" = x""yes; then :
 #define HAVE_INET_ADDR 1
 _ACEOF
 
+
 else
 
 $as_echo "#define NEED_INET_ADDR /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5865,10 +5932,12 @@ if test "x$ac_cv_func_inet_ntoa" = x""yes; then :
 #define HAVE_INET_NTOA 1
 _ACEOF
 
+
 else
 
 $as_echo "#define NEED_INET_NTOA /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5880,10 +5949,12 @@ if test "x$ac_cv_func_inet_netof" = x""yes; then :
 #define HAVE_INET_NETOF 1
 _ACEOF
 
+
 else
 
 $as_echo "#define NEED_INET_NETOF /**/" >>confdefs.h
 
+
 fi
 done
 
@@ -5971,6 +6042,7 @@ else
 
 $as_echo "#define BUFFERPOOL (18 * MAXSENDQLENGTH)" >>confdefs.h
 
+
 fi
 
 
@@ -6274,6 +6346,7 @@ if test $enable_dynamic_linking = "yes"; then :
 ac_fn_c_check_func "$LINENO" "dlopen" "ac_cv_func_dlopen"
 if test "x$ac_cv_func_dlopen" = x""yes; then :
 
+
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for dlopen in -ldl" >&5
 $as_echo_n "checking for dlopen in -ldl... " >&6; }
@@ -7281,6 +7354,8 @@ if test "${PATH_SEPARATOR+set}" != set; then
 fi
 
 
+
+
 # IFS
 # We need space, tab and new line, in precisely that order.  Quoting is
 # there to prevent editors from complaining about space-tab.
@@ -7413,6 +7488,7 @@ else
 fi # as_fn_arith
 
 
+
 if expr a : '\(a\)' >/dev/null 2>&1 &&
    test "X`expr 00001 : '.*\(...\)'`" = X001; then
   as_expr=expr
@@ -7825,6 +7901,7 @@ $debug ||
 if test -n "$CONFIG_FILES"; then
 
 
+
 ac_cr=`echo X | tr X '\015'`
 # On cygwin, bash can eat \r inside `` if the user requested igncr.
 # But we know of no other shell where ac_cr would be empty at this
diff --git a/gaymircd.conf b/gaymircd.conf
new file mode 100755
index 0000000..3c93df6
--- /dev/null
+++ b/gaymircd.conf
@@ -0,0 +1,868 @@
+/*
+ * example.conf by Daniel Hawton AKA Osiris (osiris@unrealircd.org).
+ * fixed for GAYmIRCd by brr (@berryh3h).
+ * $Id$
+ * 
+ * Works for Unreal3.2 and up
+ * 
+ * Okay guys.  This is the new example.conf. Its look is much like C++, kinda.
+ * Anyway it is time to go over this.  It's hard to pick up at first, but
+ * with some pratice and reading you'll understand.
+ *
+ * Just copy this file to your main unrealircd dir and call it 'unrealircd.conf'.
+ * 
+ * NOTE:  All lines, except the opening { line, end in an ;, including the
+ * closing } line. The IRCd will ignore commented lines.
+ *
+ * PLEASE READ doc/unreal32docs.html! The online version is also available at:
+ * www.vulnscan.org/UnrealIRCd/unreal32docs.html
+ * It contains a lot information about the configfile: gives information about
+ * every block, variable, etc..
+ * If you try to edit this file without reading the documentation properly
+ * then you are pretty much guaranteed to fail!
+ *
+ * PLEASE SEARCH for all instances of `GAYMIRCD' in this file for the
+ * recommended changes which should be applied to your own unrealircd.conf.
+ */
+
+/* Type of comments */
+#Comment type 1 (Shell type)
+// Comment type 2(C++ style)
+/* Comment type 3 (C Style) */
+#those lines are ignored by the ircd.
+
+/*
+ * UnrealIRCd supports modules, loading some of them is required.
+ * You need at least the commands module and a cloaking module.
+ */
+
+/* FOR *NIX, uncomment the following 2lines: */
+loadmodule "src/modules/commands.so";
+loadmodule "src/modules/cloak.so";
+
+/* FOR Windows, uncomment the following 2 lines: */
+//loadmodule "modules/commands.dll";
+//loadmodule "modules/cloak.dll";
+
+/*
+ * You can also include other configuration files.
+ * help.conf contains all the /helpop text. The badwords.*.conf
+ * files contain all the badword entries for mode +G...
+ * spamfilter.conf contains some good rules for current trojans.
+ * You probably want to include them:
+ */
+include "help.conf";
+/* GAYMIRCD - using badwords.all below is preferred, remove these lines
+include "badwords.channel.conf";
+include "badwords.message.conf";
+include "badwords.quit.conf";
+*/
+include "badwords.all.conf"; /* GAYMIRCD - an example file is included */
+include "spamfilter.conf";
+
+/*
+ * NEW: me {} 
+ * OLD: M:Line 
+ * me {} defines the name, description and unreal server numeric for
+ * this server. Syntax is as follows: 
+ * me { 
+ *  name "server.name"; 
+ *  info "Server Description";
+ *  numeric (server numeric*);
+ * }; 
+ * If linking, this numeric may not be used by any other server on the network.
+ */
+me
+{
+	name "irc.gay.xxx";
+	info "gaynets";
+	numeric 69;
+};
+
+/*
+ * NEW: admin {} 
+ * OLD: A:Line
+ * Admin gives information on the server admin. you
+ * may put as many lines under admin { as you wish. 
+ * Syntax is as follows:
+ * admin {
+ *   "first line"; 
+ *   "second line"; 
+ *   [etc]
+ * };
+ */
+admin {
+	"gay";
+	"nets";
+	"gaymin@gay.xxx";
+};
+
+/*
+ * NEW: class {} 
+ * OLD: Y:line (old was confusing) 
+ * These define settings for classes. A class is a group setting for 
+ * connections. Example, server connections, instead of going to a client's
+ * class, you direct it to the server class. Syntax is as follows
+ * class (class name)
+ * {
+ *     pingfreq (how often to ping a user/server in seconds);
+ *     maxclients (how many connections for this class);
+ *     sendq (maximum send queue from a connection);
+ *     recvq (maximum receive queue from a connection [flood control]);
+ *  };
+ */
+
+class           clients
+{
+	pingfreq 90;
+	maxclients 500;
+	sendq 500000; /* GAYMIRCD */
+	recvq 32000; /* GAYMIRCD */
+	options
+	{
+		nofakelag; /* GAYMIRCD - let everyone flood */
+	};
+};
+
+class           servers
+{
+	pingfreq 90;
+	maxclients 10;		/* Max servers we can have linked at a time */
+	sendq 1000000;
+	connfreq 100; /* How many seconds between each connection attempt */
+};
+
+/*
+ * NEW: allow {} 
+ * OLD: I:Line
+ * This defines allowing of connections...
+ * Basically for clients, it allows them to connect so you can have some
+ * control and/or set a password. 
+ * Syntax is as follows: 
+ * allow {
+ *    ip (ip mask to allow);
+ *    hostname (host mask);
+ *    class (class to send them to [see class {}]);
+ *    password "(password)"; (optional)
+ *    maxperip (how many connections per ip); (optional) 
+ * };
+ */
+
+allow {
+	ip             *@*;
+	hostname       *@*;
+	class           clients;
+	maxperip 5;
+};
+
+/* Passworded allow line */
+allow {
+	ip             *@255.255.255.255;
+	hostname       *@*.passworded.gay.people;
+	class           clients;
+	password "g4yNess";
+	maxperip 1;
+};
+
+/*
+ * NEW: allow channel {} 
+ * OLD: chrestrict 
+ * Allows a user to join a channel...
+ * like an except from deny channel. 
+ * Syntax:
+ * allow channel {
+ *   channel "channel name";
+ * };
+ */
+allow           channel {
+	channel "#WarezGay";
+};
+
+/*
+ * NEW: oper {} 
+ * OLD: O:Line 
+ * Defines an IRC Operator
+ * IRC operators are there to keep sanity to the server and usually keep it
+ * maintained and connected to the network. 
+ * The syntax is as follows: 
+ * oper (login) { 
+ *     class (class to put them in, if different from I, moves them to new
+ *                class); 
+ *     from { 
+ *        userhost (ident@host);
+ *        userhost (ident@host);
+ *     }; 
+ *     flags
+ *     { 
+ *       (flags here*);
+ *     };
+ *     OR
+ *     flags "old type flags, like OAaRD";
+ * };
+ */
+
+
+/* For a list of oper flags, see doc/unreal32docs.html#operblock
+ * [HIGHLY recommended to read]
+ */
+
+/*
+oper mircdadmin {
+	class           clients;
+	from {
+		userhost admin@mircd.co.uk;
+	};
+	password "g4y";
+	flags
+	{
+		netadmin;
+		can_zline;
+		can_gzline;
+		can_gkline;
+		global;
+	};
+};
+*/
+
+/*
+ * NEW: listen {}
+ * OLD: P:Line
+ * This defines a port for the ircd to bind to, to
+ * allow users/servers to connect to the server. 
+ * Syntax is as follows:
+ * listen (ip number):(port number) 
+ * { 
+ *   options {
+ *     (options here);
+ *   };
+ * };
+ * or for a plain
+ * listen: listen (ip):(port);
+ * 
+ * NOTICE: for ipv6 ips (3ffe:b80:2:51d::2 etc), use listen [ip]:port;
+ * 
+ * That works also.
+ */
+
+/* Options for listen:
+	OLD	| 	NEW
+	S		serversonly
+	C		clientsonly
+	J		java
+	s		ssl
+	*		standard
+*/
+
+/* NOTE ON SSL PORTS: SSL ports are pretty non-standardized,
+ * besides numerous high-SSL ports, some people say you should run
+ * it at 994 because that's the official SSL port.. but that
+ * requires root! Besides, port 194 is the official irc port and
+ * have you ever seen an ircd running on that?
+ * So, our suggestion is to use port 6697 for SSL, this is used by
+ * quite some networks and is recognized by for example StunTour.
+ * You are free to open up as many SSL ports as you want, but
+ * by (also) using 6697 you help the world standardize a bit ;).
+ */
+listen 69.69.69.69:6697
+{
+	options
+	{
+		ssl;
+		clientsonly;
+	};
+};
+listen 69.69.69.69:6667
+{
+	options
+	{
+		clientsonly; /* GAYMIRCD */
+	};
+};
+listen 69.69.69.69:8067;
+
+/* NOTE: If you are on an IRCd shell with multiple IP's you are
+ *       likely to get 'Address already in use' errors in your log
+ *       and the ircd won't start. This means you MUST bind
+ *       to a specific IP instead of '*', so for example:
+ *       listen 1.2.3.4:6667;
+ *       Obviously, replace the IP with the IP that was assigned to you.
+ */
+
+/*
+ * NEW: link {}
+ * OLD: C/N:Lines
+ * This defines an okay for a server connection.
+ * NOTE: BOTH SERVERS NEED A LINK {} SETTING TO CONNECT PROPERLY!
+ * Syntax is as follows:
+ * link (server name)
+ * {
+ *	username	(username, * works too);
+ * 	hostname	(ip number/hostmask);
+ *	bind-ip		(What IP to bind to when connecting, or *);
+ *	port		(port to connect to, if any);
+ *	hub (If this is a hub, * works, or servermasks it may bring in);
+ *	[or leaf *;]
+ *	password-connect "(pass to send)";
+ *	password-receive "(pass we should receive)";
+ *	class		(class to direct servers into);
+ *	options {
+ *		(options here*);
+ *	};
+ *      // If we use SSL, we can choose what cipher to use in SSL mode
+ *      // Retrieve a list by "openssl ciphers", separate ciphers with :'s
+ *      
+ *      ciphers "DES-CBC3-MD5";
+ * 
+ * };
+*/
+
+/*
+	options:
+	OLD	|	NEW
+	S		ssl
+	Z		zip
+	N/A		autoconnect
+	N/A		quarantine
+	N/A		nodnscache
+*/
+
+
+/*
+link            hub.extremechatters.com
+{
+	username	*;
+	hostname 	1.4.8.8;
+	bind-ip 	*;
+	port 		7029;
+	hub             *;
+	password-connect "ChAtSoFt";
+	password-receive "ChAtSoFt";
+	class           servers;
+		options {
+			/* Note: You should not use autoconnect when linking services */
+			autoconnect;
+			ssl;
+			zip;
+		};
+};
+*/
+/*
+ *
+ * NEW: ulines {}
+ * OLD: U:Line
+ * U-lines give servers more power/commands, this should ONLY be set
+ * for services/stats servers and NEVER for normal UnrealIRCd servers!
+ * Syntax is as follows:
+ * ulines {
+ *	(server to uline);
+ *	(server to uline);
+ *  [etc]
+ * };
+*/
+ulines {
+	services.gaaaaaaaaaaaaaaay;
+	stats.gaaaaaaaaaaaaaaay;
+};
+
+/*
+ * NEW: drpass {}
+ * OLD: X:Line
+ * This defines the passwords for /die and /restart.
+ * Syntax is as follows:
+ * drpass { 
+ *  restart		"(password for restarting)";
+ *  die		        "(password for die)";
+ * };
+ */
+drpass {
+	restart "I-love-to-be-gay";
+	die "Die-you-gay";
+};
+
+/*
+ * NEW: log {} OLD: N/A Tells the ircd where and what to log(s). You can have
+ * as many as you wish.
+ * 
+ * FLAGS: errors, kills, tkl, connects, server-connects, oper
+ * 
+ * Syntax: 
+ * log "log file" 
+ * {
+ *    flags
+ *    {
+ *        flag;
+ *        flag; 
+ *        etc.. 
+ *    }; 
+ * };
+ */
+
+log "ircd.log" {
+	/* Delete the log file and start a new one when it reaches 2MB, leave this out to always use the 
+	   same log */
+	maxsize 0; /* GAYMIRCD - fck logs? */ /*2097152*/
+	flags {
+		errors; /* GAYMIRCD */
+		/*oper;
+		connects;
+		server-connects;
+		kills;
+		sadmin-commands;
+		chg-commands;
+		oper-override;
+		spamfilter;*/
+	};
+};
+
+/*
+ * NEW: alias {}
+ * OLD: N/A
+ * This allows you to set command aliases such as /nickserv, /chanserv etc
+ * FLAGS: services, stats, normal
+ *
+ * Syntax:
+ * alias "name" {
+ *	target "points to";
+ *	type aliastype;
+ * };
+ *
+ * [NOTE: You could also include a pre-defined alias file here, see doc/unreal32docs.html section 2.9]
+ */
+
+// This points the command /nickserv to the user NickServ who is connected to the set::services-server server
+/*alias NickServ {
+	target "NickServ";
+	type services;
+};*/
+
+// If you want the command to point to the same nick as the command, you can leave the nick entry out
+//alias ChanServ { type services; };
+
+// Points the /statserv command to the user StatServ on the set::stats-server server
+//alias StatServ { type stats; };
+
+// Points the /superbot command to the user SuperBot
+//alias SuperBot { type normal; };
+
+
+/* Standard aliases */
+alias NickServ { type services; };
+alias ChanServ { type services; };
+alias OperServ { type services; };
+alias HelpServ { type services; };
+alias StatServ { type stats; };
+
+/*
+ * NEW: alias {}
+ * OLD: N/A
+ * This allows you to set command aliases such as /identify, /services, etc
+ *
+ * Syntax:
+ * alias "name" {
+ *	format "format string" {
+ *		target "points to";
+ *              type aliastype;
+ *		parameters "parameters to send";
+ *	};
+ *	type command;
+ * };
+ */
+/* This is shown seperately because even though it has teh same name as the previous directive, it is very
+ * different in syntax, although it provides a similar function and relys on the standard aliases to work.
+ */
+/*
+alias "identify" {
+	format "^#" {
+		target "chanserv";
+		type services;
+		parameters "IDENTIFY %1-";
+	};
+	format "^[^#]" {
+		target "nickserv";
+		type services;
+		parameters "IDENTIFY %1-";
+	};
+	type command;
+};
+*/
+/* The alias::format directive is a regular expression. The first format matches the /identify command when
+ * the first character is a #. It then passes this along to the chanserv alias with the parameters IDENTIFY
+ * %1-. The second format matches then /identify command when the first character is not a #. It then
+ * passes the command to the nickserv alias with parameters IDENTIFY %1-.
+ */
+
+/* The alias::format::parameters is similar to scripting languages. %N (where N is a number) represents a
+ * parameter sent to the command (in this case /identify). If you specify %N- it means all parameters from
+ * N until the last parameter in the string. You may also specify %n which is replaced by
+ * the user's nickname.
+*/
+
+/* Standard aliases */
+alias "services" {
+	format "^#" {
+		target "chanserv";
+		type services;
+		parameters "%1-";
+	};
+	format "^[^#]" {
+		target "nickserv";
+		type services;
+		parameters "%1-";
+	};
+	type command;
+};
+
+alias "identify" {
+	format "^#" {
+		target "chanserv";
+		type services;
+		parameters "IDENTIFY %1-";
+	};
+	format "^[^#]" {
+		target "nickserv";
+		type services;
+		parameters "IDENTIFY %1-";
+	};
+	type command;
+};
+
+/* This is an example of a real command alias */
+/* This maps /GLINEBOT to /GLINE <parameter> 2d etc... */
+alias "glinebot" {
+	format ".+" {
+		command "gline";
+		type real;
+		parameters "%1 2d Bots are not allowed on this server, please read the faq at http://www.example.com/faq/123";
+	};
+	type command;
+};
+
+/*
+ * NEW: files {}
+ * OLD: include/config.h
+ *
+ * This block overrides the IRCd's default paths for loading things
+ * like the MOTD, saving its PID, or writing/loading its tunefile. The
+ * existence of this block allows one UnrealIRCd installation to
+ * support multiple running instances when combined with the -c
+ * commandline option.
+ *
+ * As usual, relative paths are interpreted relative to the directory
+ * where UnrealIRCd would find unrealircd.conf if -c is _not_
+ * specified on the commandline.
+ */
+files
+{
+	/* The Message Of The Day shown to users who log in: */
+	/* motd ircd.motd; */
+
+	/*
+	 * A short MOTD. If this file exists, it will be displayed to
+	 * the user in place of the MOTD. Users can still view the
+	 * full MOTD by using the /MOTD command.
+	 */
+	/* shortmotd ircd.smotd; */
+
+	/* Shown when an operator /OPERs up */
+	/* opermotd oper.motd; */
+
+	/* Services MOTD append. */
+	/* svsmotd ircd.svsmotd; */
+
+	/* Bot MOTD */
+	/* botmotd bot.motd; */
+
+	/* Shown upon /RULES */
+	/* rules ircd.rules; */
+
+	/*
+	 * Where the IRCd stores and loads a few values which should
+	 * be persistent across server restarts. Must point to an
+	 * existing file which the IRCd has permission to alter or to
+	 * a file in a folder within which the IRCd may create files.
+	 */
+	/* tunefile ircd.tune; */
+
+	/* Where to save the IRCd's pid. Should be writable by the IRCd. */
+	/* pidfile ircd.pid; */
+};
+
+/*
+ * NEW: tld {}
+ * OLD: T:Line
+ * This sets a different motd and rules files
+ * depending on the clients hostmask.
+ * Syntax is as follows: 
+ * tld {
+ *    mask (ident@host);
+ *    motd "(motd file)";
+ *    rules "(rules file)";
+ * };
+ */
+
+/*tld {
+	mask *@*.fr;
+	motd "ircd.motd.fr";
+	rules "ircd.rules.fr";
+};*/
+
+/* note: you can just delete the example block above,
+ * in which case the defaults motd/rules files (ircd.motd, ircd.rules)
+ * will be used for everyone.
+ */
+
+/*
+ * NEW: ban nick {}
+ * OLD: Q:Line
+ * Bans a nickname, so it can't be used.
+ * Syntax is as follows:
+ * ban nick {
+ *	mask "(nick to ban)";
+ *	reason "(reason)";
+ * };
+*/
+ban nick { /* GAYMIRCD - nicks cause CRASH */
+	mask "*.*";
+	reason "unlegal characters";
+};
+/*
+ * NEW: ban ip {}
+ * OLD: Z:Line
+ * Bans an ip from connecting to the network.
+ * Syntax:
+ * ban ip { mask (ip number/hostmask); reason "(reason)"; };
+*/
+ban ip {
+	mask 195.86.232.81;
+	reason "Delinked server";
+};
+/*
+ * NEW: ban server {}
+ * OLD: Server Q:Line
+ * Disables a server from connecting to the network.
+ * if the server links to a remote server, local server
+ * will disconnect from the network.
+ * Syntax is as follows:
+ * ban server {
+ *	mask "(server name)";
+ *	reason "(reason to give)";
+ * };
+*/
+
+ban server {
+	mask irc.furnet.org;
+	reason "Get out of here.";
+};
+/*
+ * NEW: ban user {}
+ * OLD: K:Line
+ * This makes it so a user from a certain mask can't connect
+ * to your server.
+ * Syntax:
+ * ban user { mask (hostmask/ip number); reason "(reason)"; };
+*/
+
+ban user {
+	mask *@skidsr.us;
+        reason "Idiot";
+};
+
+/*
+ * NEW: ban realname {}
+ * OLD: n:Line
+ * This bans a certain realname from being used.
+ * Syntax:
+ * ban realname {
+ *	mask "(real name)";
+ * 	reason "(reason)";
+ * };
+*/
+
+ban realname {
+	mask "w1nd0wz kr4k4r";
+	reason "mIRKFORCE";
+};
+
+ban realname {
+	mask "sub666server";
+	reason "sub666";
+};
+
+/*
+ * NOTE FOR ALL BANS, they may be repeated for addition entries!
+ * 
+ * NEW: except ban {} 
+ * OLD: E:Line
+ * This makes it so you can't get banned. 
+ * Syntax:
+ * except ban { mask (ident@host); };
+ * Repeat the except ban {} as many times
+ * as you want for different hosts.
+ */
+
+except ban {
+	/* don't ban berry */
+	mask           *berru@212.*;
+};
+
+/*
+ * NEW: deny dcc {} 
+ * OLD: dccdeny.conf
+ * Use this to block dcc send's... stops
+ * viruses better. 
+ * Syntax: 
+ * deny dcc 
+ * { 
+ *   filename "file to block (ie, *exe)";
+ *   reason "reason";
+ * };
+ */
+deny dcc {
+	filename "*"; /* GAYMIRCD - dont trade anime here */
+	reason "startkeylogger";
+};
+
+/*
+ * NEW: deny channel {}
+ * OLD: N/A (NEW)
+ * This blocks channels from being joined.
+ * Syntax:
+ * deny channel {
+ * 	channel "(channel)";
+ * 	reason "reason";
+ * };
+*/
+deny channel {
+	channel "*anon*";
+	reason "Anonymous is illegal";
+};
+
+/*
+ * NEW: vhost {}
+ * OLD: Vhost.conf file
+ * This sets a fake ip for non-opers, or
+ * opers too lazy to /sethost :P
+ * Syntax:  
+ *   vhost { 
+ *       vhost (vhost.com); 
+ *       from {
+ *            userhost (ident@host to allow to use it);
+ *       };
+ *       login (login name);
+ *       password (password);
+ *   };
+ *        then to use this vhost, do /vhost (login) (password) in IRC
+ */
+vhost {
+	vhost           i.hate.austrians.com;
+	from {
+		userhost       *@*.au;
+	};
+	login           sumaussie;
+	password        nyancatsrulemyworld;
+};
+
+/* You can include other configuration files */
+/* include "klines.conf"; */
+
+/* Network configuration */
+set {
+	network-name 		"gaynets";
+	default-server 		"irc.gay.xxx";
+	services-server 	"services.gaaaaaaaaaaaaaaay";
+	stats-server 		"stats.gaaaaaaaaaaaaaaay";
+	help-channel 		"#GAY";
+	hiddenhost-prefix	"yeshomo";
+	restrict-usermodes "sk"; /* GAYMIRCD - DONT LOOK */
+	prefix-quit "str8quit:";
+	/* Cloak keys should be the same at all servers on the network.
+	 * They are used for generating masked hosts and should be kept secret.
+	 * The keys should be 3 random strings of 5-100 characters
+	 * (10-20 chars is just fine) and must consist of lowcase (a-z),
+	 * upcase (A-Z) and digits (0-9) [see first key example].
+	 * HINT: On *NIX, you can run './unreal gencloak' in your shell to let
+	 *       Unreal generate 3 random strings for you.
+	 */
+	cloak-keys { /* GAYMIRCD - change these, can use ./unreal gencloak */
+		"aoAr1HnR6gl3sJ7hVz4Zb7x4YwpW";
+		"UB66Tp73UVhdkO21NNQ2BTGHyo3X";
+		"5uuLGHy55Bv5M0fb4j58RwM1jqNJK8B";
+	};
+	/* on-oper host */
+	hosts {
+		local		"localhomo";
+		global		"localscum";
+		coadmin		"localscum";
+		admin		"localscum";
+		servicesadmin 	"localscum";
+		netadmin 	"localscum";
+		host-on-oper-up "no";
+	};
+};
+
+/* Server specific configuration */
+
+set {
+	kline-address "band@gay.xxx";
+	modes-on-connect "+Gixw"; /* GAYMIRCD - auto G helps if ur having server-wide badwords */
+	modes-on-oper	 "+xwgHs"; /* GAYMIRCD - the H hides scum from appearing as scum so ur network doesnt look too scummy */
+	oper-auto-join "#gays";
+	modes-on-join "+G"; /* GAYMIRCD - G for Gay*/
+	auto-join "#gay";
+	options {
+		flat-map; /* GAYMIRCD - hackers suck */
+		hide-ulines;
+		fail-oper-warn; /* GAYMIRCD - find out whos a scum wannabe, you scum */
+		/* You can enable ident checking here if you want */
+		/* identd-check; */
+		show-connect-info;
+	};
+
+	maxchannelsperuser 711; /* GAYMIRCD - fuck networks ware u cant even join 10 chans bloody oppressors */
+	/* The minimum time a user must be connected before being allowed to use a QUIT message,
+	 * This will hopefully help stop spam */
+	anti-spam-quit-message-time 60s; /* GAYMIRCD */
+	/* Make the message in static-quit show in all quits - meaning no
+           custom quits are allowed on local server */
+	/* static-quit "Client shuit";	*/
+
+	/* You can also block all part reasons by uncommenting this and say 'yes',
+	 * or specify some other text (eg: "Bye bye!") to always use as a comment.. */
+	/* static-part yes; */
+
+	/* This allows you to make certain stats oper only, use * for all stats,
+	 * leave it out to allow users to see all stats. Type '/stats' for a full list.
+	 * Some admins might want to remove the 'kGs' to allow normal users to list
+	 * klines, glines and shuns.
+	 */
+	oper-only-stats "*"; /* GAYMIRCD */
+
+	/* Throttling: this example sets a limit of 3 connection attempts per 60s (per host). */
+	throttle {
+		connections 3;
+		period 60s;
+	};
+
+	/* Anti flood protection */
+	anti-flood {
+		nick-flood 255:5;	/* GAYMIRCD - yay for nickname ascii */ /* 3 nickchanges per 60 seconds (the default) */
+		away-flood 255:10;	/* GAYMIRCD */
+	};
+
+	/* Spam filter */
+	spamfilter {
+		ban-time 69d; /* default duration of a *line ban set by spamfilter */
+		ban-reason "str8"; /* default reason */
+		virus-help-channel "#gay"; /* channel to use for 'viruschan' action */
+		/* except "#help"; channel to exempt from filtering */
+	};
+};
+
+/*
+ * Problems or need more help?
+ * 1) www.vulnscan.org/UnrealIRCd/unreal32docs.html
+ * 2) www.vulnscan.org/UnrealIRCd/faq/ <- contains 80% of your questions!
+ * 3) If you still have problems you can go irc.arabs.ps #arab,
+ *    note that we require you to READ THE DOCUMENTATION and FAQ first!
+ * 4) http://berryx.com/GAYmIRCd/ :3
+ */
diff --git a/include/config.h b/include/config.h
index a742ebd..70b16fa 100644
--- a/include/config.h
+++ b/include/config.h
@@ -125,7 +125,7 @@
 /*
  * Always strip badwords in channels? (channel does not have to be +G)
 */
-#undef STRIPBADWORDS_CHAN_ALWAYS
+#define STRIPBADWORDS_CHAN_ALWAYS
 
 /*
  * THROTTLING
@@ -152,7 +152,7 @@
  * HOSTILENAME - Define this if you want the hostile username patch included,
  *		 it will strip characters that are not 0-9,a-z,A-Z,_,- or .
  */
-#define HOSTILENAME		/* [DO NOT CHANGE!] */
+#undef HOSTILENAME		/* [DO NOT CHANGE!] */
 
 /*
  * Use JOIN instead of SJOIN on every remotely sent JOIN
@@ -304,7 +304,7 @@
  * Common usage for this are: a trusted bot ran by an IRCOp, that you only
  * want to give "flood access" and nothing else, and other such things.
  */
-#undef FAKELAG_CONFIGURABLE
+#define FAKELAG_CONFIGURABLE
 
 /*
  * Size of the LISTEN request.  Some machines handle this large
@@ -352,15 +352,15 @@
  * a server password set, the password is sent to NickServ in an
  * 'IDENTIFY <pass>' message.
  */
-#define NickServ "NickServ"
+#define NickServ "DickServ"
 
 /*
  * How many open targets can one nick have for messaging nicks and
  * inviting them?
  */
 
-#define MAXTARGETS		20
-#define TARGET_DELAY		15
+#define MAXTARGETS		420
+#define TARGET_DELAY		711
 
 /*   STOP STOP STOP STOP STOP STOP STOP STOP STOP STOP STOP STOP STOP STOP  */
 
@@ -476,14 +476,14 @@
  * New channelmode +f system which allows flood control for:
  * msgs, joins, ctcps, nickchanges and /knock.
  */
-#define NEWCHFLOODPROT
+#undef NEWCHFLOODPROT
 
 /* JoinThrottle (chanmode +j): +j x:y throttles users to X joins per Y seconds (per-user).
  * In peak situations (eg: just after a server restart with thousand clients joining
  * hundreds of channels) it can use like ~200k, but in normal circumstances you should
  * count on just ~10-50k.
  */
-#define JOINTHROTTLE
+#undef JOINTHROTTLE
 
 /* Detect slow spamfilters? This requires a little more cpu time when processing
  * any spamfilter (like on text/connect/..) but will save you from slowing down
diff --git a/include/dynconf.h b/include/dynconf.h
index a11fa22..c9f6135 100644
--- a/include/dynconf.h
+++ b/include/dynconf.h
@@ -332,6 +332,11 @@ struct SetCheck {
 	unsigned has_egd_path:1;
 	unsigned has_static_quit:1;
 	unsigned has_static_part:1;
+#ifdef WITH_ICONV
+	unsigned has_codepage:1;
+	unsigned has_cp_default:1;
+	unsigned has_cplist:1;
+#endif
 #ifdef USE_SSL
 	unsigned has_ssl_certificate:1;
 	unsigned has_ssl_key:1;
diff --git a/include/h.h b/include/h.h
index 6e8a28f..20da6f7 100644
--- a/include/h.h
+++ b/include/h.h
@@ -102,6 +102,9 @@ extern MODVAR ConfigItem_alias		*conf_alias;
 extern MODVAR ConfigItem_include	*conf_include;
 extern MODVAR ConfigItem_help		*conf_help;
 extern MODVAR ConfigItem_offchans	*conf_offchans;
+#ifdef WITH_ICONV
+extern MODVAR ConfigItem_codepage      *conf_codepage;
+#endif
 extern int		completed_connection(aClient *);
 extern void clear_unknown();
 extern EVENT(e_unload_module_delayed);
@@ -133,6 +136,10 @@ ConfigItem_vhost	*Find_vhost(char *name);
 ConfigItem_deny_channel *Find_channel_allowed(char *name);
 ConfigItem_alias	*Find_alias(char *name);
 ConfigItem_help 	*Find_Help(char *command);
+#ifdef WITH_ICONV 
+ConfigItem_codepage    *Find_codepage(char *name);
+ConfigItem_codepage    *Find_def_codepage(void);
+#endif
 int			AllowClient(aClient *cptr, struct hostent *hp, char *sockhost, char *username);
 int parse_netmask(const char *text, struct irc_netmask *netmask);
 int match_ip(struct IN_ADDR addr, char *uhost, char *mask, struct irc_netmask *netmask);
diff --git a/include/msg.h b/include/msg.h
index 41721da..2bd3226 100644
--- a/include/msg.h
+++ b/include/msg.h
@@ -297,6 +297,11 @@
 #define MSG_EOS		"EOS"
 #define TOK_EOS		"ES"
 
+#define MSG_CODEPAGE   "CODEPAGE"
+#define TOK_CODEPAGE   "CP"
+#define MSG_CODEPAGES  "CODEPAGES"
+#define TOK_CODEPAGES  "CPS"
+
 #define MAXPARA    	15
 
 extern int m_error();
diff --git a/include/numeric.h b/include/numeric.h
index 3b347b8..11d67b2 100644
--- a/include/numeric.h
+++ b/include/numeric.h
@@ -365,6 +365,14 @@
 
 #define RPL_WHOISSECURE      671
 
+#ifdef WITH_ICONV
+#define RPL_CODEPAGE         700
+#define RPL_CODEPAGES        701
+#define RPL_ENDOFCODEPAGES   702
+#define RPL_WHOISSCHEME      703
+#define RPL_STATSCODEPAGE    704
+#endif
+
 #define ERR_CANNOTDOCOMMAND 972
 #define ERR_CANNOTCHANGECHANMODE 974
 
diff --git a/include/struct.h b/include/struct.h
index 6a5e479..82cd607 100644
--- a/include/struct.h
+++ b/include/struct.h
@@ -119,6 +119,9 @@ typedef struct _configitem_alias_format ConfigItem_alias_format;
 typedef struct _configitem_include ConfigItem_include;
 typedef struct _configitem_help ConfigItem_help;
 typedef struct _configitem_offchans ConfigItem_offchans;
+#ifdef WITH_ICONV 
+typedef struct _configitem_codepage ConfigItem_codepage;
+#endif
 typedef struct liststruct ListStruct;
 
 #define CFG_TIME 0x0001
@@ -165,17 +168,17 @@ typedef unsigned int u_int32_t;	/* XXX Hope this works! */
 #include "dbuf.h"		/* THIS REALLY SHOULDN'T BE HERE!!! --msa */
 #endif
 
-#define	HOSTLEN		63	/* Length of hostname.  Updated to         */
+#define	HOSTLEN		160	/* Length of hostname.  Updated to         */
 				/* comply with RFC1123                     */
 
-#define	NICKLEN		30
-#define	USERLEN		10
-#define	REALLEN	 	50
-#define	TOPICLEN	307
-#define	CHANNELLEN	32
+#define	NICKLEN	        160 /* FUCK Y'ALL NIGAS */
+#define	USERLEN		160
+#define	REALLEN	 	160
+#define	TOPICLEN	711
+#define	CHANNELLEN	711
 #define	PASSWDLEN 	48	/* was 20, then 32, now 48. */
-#define	KEYLEN		23
-#define LINKLEN		32
+#define	KEYLEN		50
+#define LINKLEN		50
 #define	BUFSIZE		512	/* WARNING: *DONT* CHANGE THIS!!!! */
 #define	MAXRECIPIENTS 	20
 #define	MAXKILLS	20
@@ -998,6 +1001,9 @@ struct Client {
 	char info[REALLEN + 1];	/* Free form additional client information */
 	aClient *srvptr;	/* Server introducing this.  May be &me */
 	short status;		/* client type */
+#ifdef WITH_ICONV	
+	char *codepage;		/* Codepage */
+#endif
 	/*
 	   ** The following fields are allocated only for local clients
 	   ** (directly connected to *this* server with a socket.
@@ -1254,6 +1260,9 @@ struct _configitem_listen {
 	ConfigItem 	*prev, *next;
 	ConfigFlag 	flag;
 	char		*ip;
+#ifdef WITH_ICONV 
+	char		*codepage;
+#endif
 	int		port;
 	int		options, clients;
 	aClient		*listener;
@@ -1429,6 +1438,18 @@ struct _configitem_alias_format {
 	regex_t expr;
 };
 
+#ifdef WITH_ICONV
+struct _configitem_codepage {
+	ConfigItem *prev, *next;
+	ConfigFlag flag;
+	short defcpage;
+	char *file;
+	char repl1[256];
+	char repl2[256];
+	char *name;
+};
+#endif
+
 #define INCLUDE_NOTLOADED  0x1
 #define INCLUDE_REMOTE     0x2
 #define INCLUDE_DLQUEUED   0x4
diff --git a/ircd.motd b/ircd.motd
new file mode 100755
index 0000000..d231633
--- /dev/null
+++ b/ircd.motd
@@ -0,0 +1,7 @@
+13 _                               _ 
+13(_)_ __ ___     __ _  __ _ _   _| |
+13| | '_ ` _ \   / _` |/ _` | | | | |
+13| | | | | | | | (_| | (_| | |_| |_|
+13|_|_| |_| |_|  \__, |\__,_|\__, (_)
+13               |___/       |___/   
+			   
\ No newline at end of file
diff --git a/src/api-isupport.c b/src/api-isupport.c
index 5e2e5c9..dddc875 100644
--- a/src/api-isupport.c
+++ b/src/api-isupport.c
@@ -147,6 +147,9 @@ void isupport_init(void)
 	ircsprintf(tmpbuf, "#:%d", MAXCHANNELSPERUSER);
 	IsupportAdd(NULL, "CHANLIMIT", tmpbuf);
 	IsupportAdd(NULL, "MAXCHANNELS", my_itoa(MAXCHANNELSPERUSER));
+#ifdef WITH_ICONV
+	IsupportAdd(NULL, "CODEPAGES", NULL);
+#endif
 	IsupportAdd(NULL, "HCN", NULL);
 	IsupportAdd(NULL, "SAFELIST", NULL);
 	IsupportAdd(NULL, "NAMESX", NULL);
diff --git a/src/charsys.c b/src/charsys.c
index 54c4d2f..d1797a2 100644
--- a/src/charsys.c
+++ b/src/charsys.c
@@ -148,7 +148,8 @@ static int do_nick_name_standard(char *nick);
  * [CHANGING THIS WILL CAUSE SECURITY/SYNCH PROBLEMS AND WILL
  *  VIOLATE YOUR ""RIGHT"" ON SUPPORT IMMEDIATELY]
  */
-const char *illegalnickchars = "\xA0!+%@&~#$:'\"?*,.";
+/*const char *illegalnickchars = "\xA0!+%@&~#$:'\"?*,.";*/
+const char *illegalnickchars = ".";
 
 /** Called on boot and just before config run */
 void charsys_reset(void)
@@ -166,7 +167,7 @@ MBList *m, *m_next;
 	}
 	mblist=mblist_tail=NULL;
 	/* Then add the default which will always be allowed */
-	charsys_addallowed("0123456789-ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyzy{|}");
+	charsys_addallowed("0123456789-ABCDEFGHIJKLMNOPQRSTUVWXYZ/[\\]^_`abcdefghijklmnopqrstuvwxyzy{|}\x02\x03\x16\x1F\x1D\xA0!+%@&~#$:'\"?*,()=;<>");
 	langav = 0;
 	langsinuse[0] = '\0';
 #ifdef DEBUGMODE
@@ -264,7 +265,7 @@ void charsys_addallowed(char *s)
 {
 	for (; *s; s++)
 	{
-		if ((*s <= 32) || strchr(illegalnickchars, *s))
+		if (strchr(illegalnickchars, *s))
 		{
 			config_error("INTERNAL ERROR: charsys_addallowed() called for illegal characters: %s", s);
 #ifdef DEBUGMODE
@@ -328,7 +329,7 @@ int firstmbchar = 0;
 	for (ch=nick,len=0; *ch && len <= NICKLEN; ch++, len++)
 	{
 		/* Some characters are ALWAYS illegal, so they have to be disallowed here */
-		if ((*ch <= 32) || strchr(illegalnickchars, *ch))
+		if (strchr(illegalnickchars, *ch))
 			return 0;
 		if (firstmbchar)
 		{
@@ -357,7 +358,7 @@ int do_remote_nick_name(char *nick)
 char *c;
 
 	for (c=nick; *c; c++)
-		if ((*c <= 32) || strchr(illegalnickchars, *c))
+		if (strchr(illegalnickchars, *c))
 			return 0;
 
 	return (c - nick);
diff --git a/src/extbans.c b/src/extbans.c
index b634ab8..7583bcb 100644
--- a/src/extbans.c
+++ b/src/extbans.c
@@ -379,7 +379,7 @@ char pfix[8];
  */
 char* extban_conv_param_nuh_or_extban(char* para)
 {
-#if (USERLEN + NICKLEN + HOSTLEN + 32) > 256
+#if (USERLEN + NICKLEN + HOSTLEN + 32) > 512
  #error "wtf?"
 #endif
 	static char retbuf[256];
diff --git a/src/modules/Makefile.in b/src/modules/Makefile.in
index 5e3a78d..968de14 100644
--- a/src/modules/Makefile.in
+++ b/src/modules/Makefile.in
@@ -54,7 +54,7 @@ R_MODULES= \
 	 m_connect.so m_dccallow.so m_userip.so m_nick.so m_user.so \
 	 m_mode.so m_watch.so m_part.so m_join.so m_motd.so m_opermotd.so \
 	 m_botmotd.so m_lusers.so m_names.so m_svsnolag.so m_addmotd.so \
-	 m_svslusers.so m_starttls.so m_nopost.so m_issecure.so
+	 m_svslusers.so m_starttls.so m_nopost.so m_issecure.so m_codepage.so
 
 #note change of .c to .o
 COMMANDS=m_sethost.o m_chghost.o m_chgident.o m_setname.o m_setident.o \
@@ -77,7 +77,7 @@ COMMANDS=m_sethost.o m_chghost.o m_chgident.o m_setname.o m_setident.o \
 	 m_connect.o m_dccallow.o m_userip.o m_nick.o m_user.o \
 	 m_mode.o m_watch.o m_part.o m_join.o m_motd.o m_opermotd.o \
 	 m_botmotd.o m_lusers.o m_names.o m_svsnolag.o m_starttls.o \
-	 m_nopost.o m_issecure.o
+	 m_nopost.o m_issecure.o m_codepage.o
 
 
 MODULES=commands.so cloak.so $(R_MODULES)
@@ -419,6 +419,8 @@ m_nopost.o: m_nopost.c $(INCLUDES)
 m_issecure.o: m_issecure.c $(INCLUDES)
 	$(CC) $(CFLAGS) $(MODULEFLAGS) -c m_issecure.c
 
+m_codepage.o: m_codepage.c $(INCLUDES)
+	$(CC) $(CFLAGS) $(MODULEFLAGS)  -c m_codepage.c
 #############################################################################
 #             .so's section
 #############################################################################
@@ -843,6 +845,9 @@ m_issecure.so: m_issecure.c $(INCLUDES)
 	$(CC) $(CFLAGS) $(MODULEFLAGS) -DDYNAMIC_LINKING \
 		-o m_issecure.so m_issecure.c
 
+m_codepage.so: m_codepage.c $(INCLUDES)
+	$(CC) $(CFLAGS) $(MODULEFLAGS) -DDYNAMIC_LINKING \
+	        -o m_codepage.so m_codepage.c
 #############################################################################
 #             and now the remaining modules...
 #############################################################################
diff --git a/src/modules/l_commands.c b/src/modules/l_commands.c
index 19612a8..c5f878a 100644
--- a/src/modules/l_commands.c
+++ b/src/modules/l_commands.c
@@ -130,6 +130,9 @@ extern int m_issecure_Init(ModuleInfo *modinfo);
 extern int m_guest_Init(ModuleInfo *modinfo);
 #endif
 
+#ifdef WITH_ICONV
+extern int m_codepage_Init(ModuleInfo *modinfo);
+#endif
 extern int m_sethost_Load(int module_load), m_setname_Load(int module_load), m_chghost_Load(int module_load);
 extern int m_chgident_Load(int module_load), m_setident_Load(int module_load), m_sdesc_Load(int module_load);
 extern int m_svsmode_Load(int module_load), m_swhois_Load(int module_load), m_svsmotd_Load(int module_load);
@@ -182,6 +185,9 @@ extern int m_issecure_Load(int module_load);
 extern int m_guest_Load(int module_load);
 #endif
 
+#ifdef WITH_ICONV
+extern int m_codepage_Load(int module_load);
+#endif
 extern int m_sethost_Unload(), m_setname_Unload(), m_chghost_Unload(), m_chgident_Unload();
 extern int m_setident_Unload(), m_sdesc_Unload(), m_svsmode_Unload(), m_swhois_Unload();
 extern int m_svsmotd_Unload(), m_svsnline_Unload(), m_who_Unload(), m_mkpasswd_Unload();
@@ -221,6 +227,9 @@ extern int m_issecure_Unload();
 extern int m_guest_Unload();
 #endif
 
+#ifdef WITH_ICONV 
+extern int m_codepage_Unload();
+#endif
 #ifdef DYNAMIC_LINKING
 DLLFUNC int Mod_Test(ModuleInfo *modinfo)
 #else
@@ -365,6 +374,11 @@ int    l_commands_Init(ModuleInfo *modinfo)
 #ifdef GUEST
 	m_guest_Init(ModCmdsInfo);
 #endif
+
+#ifdef WITH_ICONV
+	m_codepage_Init(ModCmdsInfo);
+#endif
+
 	MARK_AS_OFFICIAL_MODULE(modinfo);
 	return MOD_SUCCESS;
 }
@@ -480,6 +494,10 @@ int    l_commands_Load(int module_load)
 #ifdef GUEST
 	m_guest_Load(module_load);
 #endif
+
+#ifdef WITH_ICONV
+	m_codepage_Load(module_load);
+#endif
 	return MOD_SUCCESS;
 }
 
@@ -595,6 +613,10 @@ int	l_commands_Unload(int module_unload)
 #ifdef GUEST
 	m_guest_Unload();
 #endif
+
+#ifdef WITH_ICONV
+	m_codepage_Unload();
+#endif
 	return MOD_SUCCESS;
 }
 
diff --git a/src/modules/m_chghost.c b/src/modules/m_chghost.c
index 665c150..5f8c53b 100644
--- a/src/modules/m_chghost.c
+++ b/src/modules/m_chghost.c
@@ -134,8 +134,7 @@ DLLFUNC int m_chghost(aClient *cptr, aClient *sptr, int parc, char *parv[])
 
 	if (!valid_host(parv[2]))
 	{
-		sendnotice(sptr, "*** /ChgHost Error: A hostname may contain a-z, A-Z, 0-9, '-' & '.' - Please only use them");
-		return 0;
+		valid_host(parv[2]);
 	}
 
 	if (parv[2][0] == ':')
diff --git a/src/modules/m_chgident.c b/src/modules/m_chgident.c
index fde6325..1fae3b6 100644
--- a/src/modules/m_chgident.c
+++ b/src/modules/m_chgident.c
@@ -146,14 +146,13 @@ int  legalident = 1;
 			continue;
 		if (!isallowed(*s))
 		{
-			legalident = 0;
+			isallowed(*s);
 		}
 	}
 
 	if (legalident == 0)
 	{
-		sendnotice(sptr, "*** /ChgIdent Error: A ident may contain a-z, A-Z, 0-9, '-' & '.' - Please only use them");
-		return 0;
+		legalident = 1;
 	}
 
 	if ((acptr = find_person(parv[1], NULL)))
diff --git a/src/modules/m_codepage.c b/src/modules/m_codepage.c
new file mode 100755
index 0000000..5b50d8e
--- /dev/null
+++ b/src/modules/m_codepage.c
@@ -0,0 +1,196 @@
+/*
+ *   IRC - Internet Relay Chat, src/modules/m_codepage.c
+ *   (C) 1999-2001 Carsten Munk (Techie/Stskeeps) <stskeeps@tspre.org>
+ *
+ *   See file AUTHORS in IRC package for additional names of
+ *   the programmers. 
+ *
+ *   This program is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU General Public License as published by
+ *   the Free Software Foundation; either version 1, or (at your option)
+ *   any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU General Public License for more details.
+ *
+ *   You should have received a copy of the GNU General Public License
+ *   along with this program; if not, write to the Free Software
+ *   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ */
+#include "config.h"
+#include "struct.h"
+#include "common.h"
+#include "sys.h"
+#include "numeric.h"
+#include "msg.h"
+#include "channel.h"
+#include <time.h>
+#include <sys/stat.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#ifdef _WIN32
+#include <io.h>
+#endif
+#include <fcntl.h>
+#include "h.h"
+#include "proto.h"
+#ifdef STRIPBADWORDS
+#include "badwords.h"
+#endif
+#ifdef _WIN32
+#include "version.h"
+#endif
+
+DLLFUNC int m_codepage(aClient *cptr, aClient *sptr, int parc, char *parv[]);
+DLLFUNC int m_codepages(aClient *cptr, aClient *sptr, int parc, char *parv[]);
+
+ModuleHeader MOD_HEADER(m_codepage)
+	= {
+	"codepage",    /* Name of module */
+	"$Id: m_codepage.c,v 1.1.0.0 2002/12/29 14:20:45 i (admin@i386.net.ru) & Spider Exp $", /* Version */
+	"/codepage", /* Short description of module */
+	"3.2-b8-1",
+	};
+
+/*
+ * The purpose of these ifdefs, are that we can "static" link the ircd if we
+ * want to
+*/
+
+
+DLLFUNC int    MOD_INIT(m_codepage)(ModuleInfo *modinfo)
+{
+	add_Command(MSG_CODEPAGE, TOK_CODEPAGE, m_codepage, MAXPARA);
+	add_Command(MSG_CODEPAGES, TOK_CODEPAGES, m_codepages, MAXPARA);
+	return MOD_SUCCESS;
+    
+}
+
+DLLFUNC int    MOD_LOAD(m_codepage)(int module_load)
+{
+	return MOD_SUCCESS;
+}
+
+DLLFUNC int    MOD_UNLOAD(m_codepage)(int module_unload)
+{
+	if (del_Command(MSG_CODEPAGE, TOK_CODEPAGE, m_codepage) < 0)
+	{
+		sendto_realops("Failed to delete commands when unloading %s",
+			MOD_HEADER(m_codepage).name);
+	}
+	return MOD_SUCCESS;
+}
+
+/* 
+ * m_codepage - 12/29/2002 - ECTb
+ * :prefix CODEPAGE <new codepage>
+ * parv[0] - sender
+ * parv[1] - codepage
+ *
+*/
+
+DLLFUNC int m_codepage(aClient *cptr, aClient *sptr, int parc, char *parv[])
+{
+	if (!MyClient(sptr)) 
+	{
+		aClient *acptr;
+#ifndef WITH_ICONV
+	if (MyClient(sptr))
+	{
+		sendto_one(sptr, ":%s NOTICE %s :*** The /codepage command is disabled on this server", 
+				me.name, sptr->name);
+		return 0;
+	}
+#else
+	if (parc < 3)
+		return 0;    
+	acptr = find_person(parv[1], (aClient *)NULL);
+		if (!acptr)
+			return 0;
+	if (Find_codepage(parv[2])) 
+	{
+		if (!acptr->codepage)
+			acptr->codepage=strdup(parv[2]);
+		else
+			strcpy(acptr->codepage, parv[2]);
+	}
+#endif
+	return 0;
+	}
+
+#ifdef WITH_ICONV
+	
+	if (parc < 2)
+	{
+	sendto_one(sptr,
+		":%s NOTICE %s :*** /codepage syntax is /codepage <new_codepage>",
+			me.name, sptr->name);
+	sendto_one(sptr,
+		":%s NOTICE %s :*** Your current codepage is: %s Port: %d",
+			me.name, sptr->name, sptr->codepage, cptr->listener->port);
+		return 0;
+	}
+
+	if (strlen(parv[1]) < 1)
+	{
+	sendto_one(sptr,
+		":%s NOTICE %s :*** Write atleast something to change the codepage to!",
+			me.name, sptr->name);
+		return 0;
+	}
+
+	if (strlen(parv[1]) > 16)
+	{
+		sendto_one(sptr,
+			":%s NOTICE %s :*** Codepage Error: Too long codepage!!",
+				me.name, sptr->name);
+		return 0;
+	}
+
+	if (Find_codepage(parv[1]))
+	{
+		sptr->codepage = strdup(parv[1]);
+		sendto_one(sptr, rpl_str(RPL_CODEPAGE), me.name, parv[0], sptr->codepage);
+		sendto_serv_butone_token(cptr, sptr->name,
+			MSG_CODEPAGE, TOK_CODEPAGE, "%s :%s", sptr->name, sptr->codepage);
+	return 0;
+	}
+	else
+	{
+		sendto_one(sptr,
+			":%s NOTICE %s :*** /Codepage Error: Unknown codepage %s",
+				me.name, parv[0], parv[1]);
+		return 0;
+	}
+#endif
+	return 0;
+
+}
+
+
+/* 
+ * m_codepages - 2/09/2003 - ECTb
+ * :prefix CODEPAGES
+ * parv[0] - sender
+ *
+*/
+
+DLLFUNC int m_codepages(aClient *cptr, aClient *sptr, int parc, char *parv[])
+{
+#ifdef WITH_ICONV
+	ConfigItem_codepage *cpage = NULL;
+	for (cpage = conf_codepage; cpage; cpage = (ConfigItem_codepage *)cpage->next) 
+	{
+		sendto_one(sptr, rpl_str(RPL_CODEPAGES), me.name, 
+			parv[0], cpage->name, cpage->defcpage?" default":"");
+	}
+	sendto_one(sptr, rpl_str(RPL_ENDOFCODEPAGES), me.name, parv[0]);
+#else
+	sendto_one(sptr, ":%s NOTICE %s :*** The /codepages command is disabled on this server", 
+				me.name, sptr->name);
+#endif
+	return 0;
+}
diff --git a/src/modules/m_mode.c b/src/modules/m_mode.c
index 2176a0a..84adeac 100644
--- a/src/modules/m_mode.c
+++ b/src/modules/m_mode.c
@@ -878,9 +878,9 @@ int  do_mode_char(aChannel *chptr, long modetype, char modechar, char *param,
 	  case MODE_NOPRIVMSGS:
 	  case MODE_RGSTRONLY:
 	  case MODE_MODREG:
-	  case MODE_NOCOLOR:
+	  /*case MODE_NOCOLOR:*/
 	  case MODE_NOKICKS:
-	  case MODE_STRIP:
+	  /*case MODE_STRIP:*/
 	  	goto setthephuckingmode;
 
 	  case MODE_INVITEONLY:
@@ -909,12 +909,12 @@ int  do_mode_char(aChannel *chptr, long modetype, char modechar, char *param,
 			  if (modetype == MODE_PRIVATE
 			      && (chptr->mode.mode & MODE_SECRET))
 				  chptr->mode.mode &= ~MODE_SECRET;
-			  if (modetype == MODE_NOCOLOR
+/*			  if (modetype == MODE_NOCOLOR
 			      && (chptr->mode.mode & MODE_STRIP))
 				  chptr->mode.mode &= ~MODE_STRIP;
 			  if (modetype == MODE_STRIP
 			      && (chptr->mode.mode & MODE_NOCOLOR))
-				  chptr->mode.mode &= ~MODE_NOCOLOR;
+				  chptr->mode.mode &= ~MODE_NOCOLOR;*/
 			  chptr->mode.mode |= modetype;
 		  }
 		  else
diff --git a/src/modules/m_nick.c b/src/modules/m_nick.c
index d3cf500..7d886a4 100644
--- a/src/modules/m_nick.c
+++ b/src/modules/m_nick.c
@@ -150,11 +150,10 @@ DLLFUNC CMD_FUNC(m_nick)
 	 * For remote clients, do a quick check by using do_remote_nick_name(),
 	 * if this returned false then reject and kill it. -- Syzop
 	 */
-	if ((IsServer(cptr) && !do_remote_nick_name(nick)) ||
-	    (!IsServer(cptr) && !do_nick_name(nick)))
+	if (!do_remote_nick_name(nick)) /* just do some basic checking */
 	{
 		sendto_one(sptr, err_str(ERR_ERRONEUSNICKNAME),
-		    me.name, parv[0], parv[1], "Illegal characters");
+		    me.name, parv[0], parv[1], "Unlegal characters");
 
 		if (IsServer(cptr))
 		{
@@ -832,6 +831,9 @@ extern int short_motd(aClient *sptr);
 int _register_user(aClient *cptr, aClient *sptr, char *nick, char *username, char *umode, char *virthost, char *ip)
 {
 	ConfigItem_ban *bconf;
+#ifdef WITH_ICONV
+	ConfigItem_listen *plisten;
+#endif
 	char *parv[3], *tmpstr;
 #ifdef HOSTILENAME
 	char stripuser[USERLEN + 1], *u1 = stripuser, *u2, olduser[USERLEN + 1],
@@ -863,6 +865,21 @@ int _register_user(aClient *cptr, aClient *sptr, char *nick, char *username, cha
 	
 	if (MyConnect(sptr))
 	{
+#ifdef WITH_ICONV
+		plisten = Find_listen("*",cptr->listener->port);
+		if (plisten)
+		{
+			cptr->codepage = strdup(plisten->codepage);
+			sendto_one(cptr, ":%s NOTICE AUTH :*** You connected on %d port. Using %s translation scheme as default.", 
+				me.name, cptr->listener->port, cptr->codepage);
+		}
+		else
+		{
+			cptr->codepage = strdup(Find_def_codepage()->name);
+			sendto_one(cptr, ":%s NOTICE AUTH :*** You connected on %d port. Translation scheme not specified for this port.",
+					me.name, cptr->listener->port);
+               }
+#endif
 		if ((i = check_client(sptr, username))) {
 			/* This had return i; before -McSkaf */
 			if (i == -5)
@@ -1174,6 +1191,17 @@ int _register_user(aClient *cptr, aClient *sptr, char *nick, char *username, cha
 	    (!buf || *buf == '\0' ? "+" : buf),
 	    sptr->umodes & UMODE_SETHOST ? sptr->user->virthost : NULL);
 
+#ifdef WITH_ICONV
+	if (MyConnect(sptr))
+	{
+		if (sptr->codepage)
+		{
+			sendto_one(sptr, rpl_str(RPL_CODEPAGE), sptr->name, parv[0], sptr->codepage);
+			sendto_serv_butone_token(sptr, sptr->name,
+				MSG_CODEPAGE, TOK_CODEPAGE, "%s :%s", sptr->name, sptr->codepage);
+		}
+	}
+#endif
 	/* Send password from sptr->passwd to NickServ for identification,
 	 * if passwd given and if NickServ is online.
 	 * - by taz, modified by Wizzu
diff --git a/src/modules/m_server.c b/src/modules/m_server.c
index 34a510c..20847dd 100644
--- a/src/modules/m_server.c
+++ b/src/modules/m_server.c
@@ -988,6 +988,13 @@ int	m_server_synch(aClient *cptr, long numeric, ConfigItem_link *aconf)
 					    MSG_SWHOIS), acptr->name,
 					    acptr->user->swhois);
 
+#ifdef WITH_ICONV
+			if (acptr->codepage)
+				if (*acptr->codepage != '\0')
+					sendto_one(cptr, "%s %s :%s",
+					    (IsToken(cptr) ? TOK_CODEPAGE :
+					    MSG_CODEPAGE), acptr->name, acptr->codepage);
+#endif
 			if (!SupportSJOIN(cptr))
 				send_user_joins(cptr, acptr);
 		}
diff --git a/src/modules/m_sethost.c b/src/modules/m_sethost.c
index d27702b..a6a62a6 100644
--- a/src/modules/m_sethost.c
+++ b/src/modules/m_sethost.c
@@ -175,11 +175,9 @@ DLLFUNC int m_sethost(aClient *cptr, aClient *sptr, int parc, char *parv[])
 
 	if (!valid_host(vhost))
 	{
-		sendto_one(sptr,
-		    ":%s NOTICE %s :*** /SetHost Error: A hostname may contain a-z, A-Z, 0-9, '-' & '.' - Please only use them",
-		    me.name, parv[0]);
-		return 0;
+		valid_host(vhost);
 	}
+
 	if (vhost[0] == ':')
 	{
 		sendto_one(sptr, ":%s NOTICE %s :*** A hostname cannot start with ':'", me.name, sptr->name);
diff --git a/src/modules/m_setident.c b/src/modules/m_setident.c
index 6d174ce..d1e2d5b 100644
--- a/src/modules/m_setident.c
+++ b/src/modules/m_setident.c
@@ -182,17 +182,13 @@ DLLFUNC int m_setident(aClient *cptr, aClient *sptr, int parc, char *parv[])
 			continue;
 		if (!isallowed(*s))
 		{
-			legalident = 0;
-			break;
+			isallowed(*s);
 		}
 	}
 
 	if (legalident == 0)
 	{
-		sendto_one(sptr,
-		    ":%s NOTICE %s :*** /SetIdent Error: A username may contain a-z, A-Z, 0-9, '-', '~' & '.' - Please only use them",
-		    me.name, parv[0]);
-		return 0;
+		legalident = 1;
 	}
 
 	{
diff --git a/src/modules/m_stats.c b/src/modules/m_stats.c
index 0b7b8ad..2bbf505 100644
--- a/src/modules/m_stats.c
+++ b/src/modules/m_stats.c
@@ -120,6 +120,9 @@ int stats_zip(aClient *, char *);
 int stats_officialchannels(aClient *, char *);
 int stats_spamfilter(aClient *, char *);
 
+#ifdef WITH_ICONV
+int stats_codepages(aClient *, char *);
+#endif
 #define SERVER_AS_PARA 0x1
 #define FLAGS_AS_PARA 0x2
 
@@ -168,6 +171,9 @@ struct statstab StatsTable[] = {
 	{ 'm', "command",	stats_command,		0 		},
 	{ 'n', "banrealname",	stats_banrealname,	0 		},
 	{ 'o', "oper",		stats_oper,		0 		},
+#ifdef WITH_ICONV
+	{ 'p', "codepages",	stats_codepages,	0		},
+#endif
 	{ 'q', "bannick",	stats_bannick,		FLAGS_AS_PARA	},
 	{ 'r', "chanrestrict",	stats_chanrestrict,	0 		},
 	{ 's', "shun",		stats_shun,		FLAGS_AS_PARA	},
@@ -273,6 +279,10 @@ inline void stats_help(aClient *sptr)
 		"n - banrealname - Send the ban realname block list");
 	sendto_one(sptr, rpl_str(RPL_STATSHELP), me.name, sptr->name,
 		"O - oper - Send the oper block list");
+#ifdef WITH_ICONV
+	sendto_one(sptr, rpl_str(RPL_STATSHELP), me.name, sptr->name,
+		"p - codepages - Send information about codepages");
+#endif
 	sendto_one(sptr, rpl_str(RPL_STATSHELP), me.name, sptr->name,
 		"P - port - Send information about ports");
 	sendto_one(sptr, rpl_str(RPL_STATSHELP), me.name, sptr->name,
@@ -684,12 +694,19 @@ int stats_port(aClient *sptr, char *para)
 			continue;
 	  	if (!IsListening(acptr))
 	  		continue;
-	  	sendto_one(sptr, ":%s %s %s :*** Listener on %s:%i, clients %i. is %s %s",
+#ifdef WITH_ICONV
+		sendto_one(sptr, ":%s %s %s :*** Listener on %s:%i, clients %i. is %s %s %s",
+#else
+		sendto_one(sptr, ":%s %s %s :*** Listener on %s:%i, clients %i. is %s %s %s",
+#endif
 	  		me.name, IsWebTV(sptr) ? "PRIVMSG" : "NOTICE", sptr->name,
 	  		((ConfigItem_listen *)acptr->class)->ip,
 			((ConfigItem_listen *)acptr->class)->port,
 			((ConfigItem_listen *)acptr->class)->clients,
 			((ConfigItem_listen *)acptr->class)->flag.temporary ? "TEMPORARY" : "PERM",
+#ifdef WITH_ICONV
+			((ConfigItem_listen *)acptr->class)->codepage ? ((ConfigItem_listen *)acptr->class)->codepage : (conf_codepage->defcpage?Find_def_codepage()->name:"CP1251"),
+#endif
 			stats_port_helper(acptr));
 	}
 	return 0;
@@ -709,6 +726,17 @@ int stats_usage(aClient *sptr, char *para)
 	return 0;
 }
 
+#ifdef WITH_ICONV
+int stats_codepages(aClient *sptr, char *para)
+{
+	ConfigItem_codepage *x;
+	for (x = conf_codepage; x; x = (ConfigItem_codepage *)x->next)
+		sendto_one(sptr, ":%s %i %s :%s %s",
+			me.name, RPL_TEXT, sptr->name, x->name, x->defcpage ? "- default" : "");
+	return 0;
+}
+#endif
+
 int stats_traffic(aClient *sptr, char *para)
 {
 	aClient *acptr;
diff --git a/src/modules/m_whois.c b/src/modules/m_whois.c
index 7c14fd3..b9cb7c9 100644
--- a/src/modules/m_whois.c
+++ b/src/modules/m_whois.c
@@ -321,6 +321,12 @@ DLLFUNC int  m_whois(aClient *cptr, aClient *sptr, int parc, char *parv[])
 					    me.name, RPL_WHOISSPECIAL, parv[0],
 					    name, acptr->user->swhois);
 
+                       /* CODEPAGE USE by i (admin@i386.net.ru) */
+#ifdef WITH_ICONV
+		sendto_one(sptr, rpl_str(RPL_WHOISSCHEME),
+			me.name, parv[0], name,
+			acptr->codepage ? acptr->codepage : Find_def_codepage()->name);
+#endif
 			/*
 			 * Fix /whois to not show idle times of
 			 * global opers to anyone except another
diff --git a/src/s_bsd.c b/src/s_bsd.c
index d002a02..9217de3 100644
--- a/src/s_bsd.c
+++ b/src/s_bsd.c
@@ -69,6 +69,10 @@ Computing Center and Jarkko Oikarinen";
 #include  "fdlist.h"
 #endif
 
+
+#ifdef WITH_ICONV
+#include <iconv.h>
+#endif
 #ifdef INET6
 static unsigned char minus_one[] =
     { 255, 255, 255, 255, 255, 255, 255, 255, 255,
@@ -1403,6 +1407,42 @@ doauth:
 	start_auth(acptr);
 }
 
+#ifdef WITH_ICONV
+/*
+ *  decoding codepage...
+ */
+
+int	dech_codepage(char *codepage, int *length) 
+{
+	static char buf[READBUF_SIZE];
+	const char *p1 = readbuf;
+	char *p2 = buf;
+	size_t s1, s2, bytes;
+	iconv_t cd;
+	ConfigItem_codepage *cp = Find_def_codepage();
+	if (!codepage || !cp) 
+		return 0;
+	if (!stricmp(codepage, cp->name)) 
+	{ 
+		return 0; 
+	}
+	cd = iconv_open (cp->name, codepage);
+	if (cd == (iconv_t)(-1)) 
+		return 0;
+	s1 = *length;
+	s2 = READBUF_SIZE;
+	bytes = iconv (cd, (char **)&p1, &s1, &p2, &s2);
+	if (bytes < 0 || s1 != 0) 
+	{
+		iconv_close (cd);
+		return 0;
+	}
+	*length = READBUF_SIZE - s2;
+	memcpy(readbuf,buf,*length);
+	readbuf[*length]='\0';
+	iconv_close(cd);
+}    
+#endif
 void proceed_normal_client_handshake(aClient *acptr, struct hostent *he)
 {
 	ClearDNS(acptr);
@@ -1438,6 +1478,9 @@ static int read_packet(aClient *cptr, fd_set *rfd)
 		else
 #endif
 			length = recv(cptr->fd, readbuf, sizeof(readbuf), 0);
+#ifdef WITH_ICONV
+		if (!IsServer(cptr)) dech_codepage(cptr->codepage,&length);
+#endif
 		cptr->lasttime = now;
 		if (cptr->lasttime > cptr->since)
 			cptr->since = cptr->lasttime;
diff --git a/src/s_conf.c b/src/s_conf.c
index c27a054..7931246 100644
--- a/src/s_conf.c
+++ b/src/s_conf.c
@@ -110,6 +110,9 @@ static int	_conf_help		(ConfigFile *conf, ConfigEntry *ce);
 static int	_conf_offchans		(ConfigFile *conf, ConfigEntry *ce);
 static int	_conf_spamfilter	(ConfigFile *conf, ConfigEntry *ce);
 static int	_conf_cgiirc	(ConfigFile *conf, ConfigEntry *ce);
+#ifdef WITH_ICONV
+static int	_conf_codepage		(ConfigFile *conf, ConfigEntry *ce);
+#endif
 
 /* 
  * Validation commands 
@@ -144,6 +147,9 @@ static int	_test_help		(ConfigFile *conf, ConfigEntry *ce);
 static int	_test_offchans		(ConfigFile *conf, ConfigEntry *ce);
 static int	_test_spamfilter	(ConfigFile *conf, ConfigEntry *ce);
 static int	_test_cgiirc	(ConfigFile *conf, ConfigEntry *ce);
+#ifdef WITH_ICONV
+static int	_test_codepage		(ConfigFile *conf, ConfigEntry *ce);
+#endif
  
 /* This MUST be alphabetized */
 static ConfigCommand _ConfigCommands[] = {
@@ -156,6 +162,9 @@ static ConfigCommand _ConfigCommands[] = {
 	{ "ban", 		_conf_ban,		_test_ban	},
 	{ "cgiirc", 	_conf_cgiirc,	_test_cgiirc	},
 	{ "class", 		_conf_class,		_test_class	},
+#ifdef WITH_ICONV 
+        { "codepage",		_conf_codepage,		_test_codepage  },
+#endif
 	{ "deny",		_conf_deny,		_test_deny	},
 	{ "drpass",		_conf_drpass,		_test_drpass	},
 	{ "except",		_conf_except,		_test_except	},
@@ -392,6 +401,9 @@ ConfigItem_badword	*conf_badword_quit = NULL;
 #endif
 ConfigItem_offchans	*conf_offchans = NULL;
 
+#ifdef WITH_ICONV
+ConfigItem_codepage	*conf_codepage = NULL;
+#endif
 aConfiguration		iConf;
 MODVAR aConfiguration		tempiConf;
 MODVAR ConfigFile		*conf = NULL;
@@ -2046,6 +2058,9 @@ void	config_rehash()
 	ConfigItem_help			*help_ptr;
 	ConfigItem_offchans		*of_ptr;
 	OperStat 			*os_ptr;
+#ifdef WITH_ICONV
+	ConfigItem_codepage		*codepage_ptr;
+#endif
 	ListStruct 	*next, *next2;
 	aTKline *tk, *tk_next;
 	SpamExcept *spamex_ptr;
@@ -2335,6 +2350,15 @@ void	config_rehash()
 		DelListItem(alias_ptr, conf_alias);
 		MyFree(alias_ptr);
 	}
+#ifdef WITH_ICONV
+	for (codepage_ptr = conf_codepage; codepage_ptr; codepage_ptr = (ConfigItem_codepage *)next)
+	{
+		next = (ListStruct *)codepage_ptr->next;
+		ircfree(codepage_ptr->name);
+		DelListItem(codepage_ptr, conf_codepage);
+		MyFree(codepage_ptr);
+	}
+#endif
 	for (help_ptr = conf_help; help_ptr; help_ptr = (ConfigItem_help *)next) {
 		aMotdLine *text;
 		next = (ListStruct *)help_ptr->next;
@@ -2406,6 +2430,9 @@ void	config_rehash()
 int	config_post_test()
 {
 #define Error(x) { config_error((x)); errors++; }
+#ifdef WITH_ICONV
+	ConfigItem_listen	*p = NULL;
+#endif
 	int 	errors = 0;
 	Hook *h;
 	
@@ -2671,6 +2698,28 @@ ConfigItem_alias *Find_alias(char *name) {
 	return NULL;
 }
 
+#ifdef WITH_ICONV
+ConfigItem_codepage    *Find_codepage(char *name) {
+	ConfigItem_codepage *codepage;
+	if (!name)
+		return NULL;
+	for (codepage = conf_codepage; codepage; codepage = (ConfigItem_codepage *)codepage->next) {
+		if (!stricmp(codepage->name, name))
+			return codepage;
+	}
+	return NULL;
+}
+
+ConfigItem_codepage    *Find_def_codepage(void) {
+	ConfigItem_codepage *codepage;
+	for (codepage = conf_codepage; codepage; codepage = (ConfigItem_codepage *)codepage->next) {
+		if (codepage->defcpage)
+			return codepage;
+	}
+	return NULL;
+}
+#endif
+
 ConfigItem_class	*Find_class(char *name)
 {
 	ConfigItem_class	*p;
@@ -4544,6 +4593,9 @@ int	_conf_listen(ConfigFile *conf, ConfigEntry *ce)
 	char	    copy[256];
 	char	    *ip;
 	char	    *port;
+#ifdef WITH_ICONV
+	char	    *tempcodepage;
+#endif
 	int	    start, end, iport, isnew;
 	int tmpflags =0;
 
@@ -4578,6 +4630,12 @@ int	_conf_listen(ConfigFile *conf, ConfigEntry *ce)
 					tmpflags |= ofp->flag;
 			}
 		}
+#ifdef WITH_ICONV
+		if (!strcmp(cep->ce_varname, "codepage"))
+		{
+			tempcodepage = strdup(cep->ce_vardata);
+		}
+#endif
 	}
 #ifndef USE_SSL
 	tmpflags &= ~LISTENER_SSL;
@@ -4597,6 +4655,10 @@ int	_conf_listen(ConfigFile *conf, ConfigEntry *ce)
 			tmpflags |= LISTENER_BOUND;
 
 		listen->options = tmpflags;
+#ifdef WITH_ICONV
+		if (!tempcodepage) listen->codepage = strdup(Find_def_codepage()->name);
+		else listen->codepage = strdup(tempcodepage);
+#endif
 		if (isnew)
 			AddListItem(listen, conf_listen);
 		listen->flag.temporary = 0;
@@ -4614,6 +4676,9 @@ int	_test_listen(ConfigFile *conf, ConfigEntry *ce)
 	int	    start, end;
 	int	    errors = 0;
 	char has_options = 0;
+#ifdef WITH_ICONV
+	char has_codepage = 0;
+#endif
 	OperFlag    *ofp;
 
 	if (!ce->ce_vardata)
@@ -4737,6 +4802,12 @@ int	_test_listen(ConfigFile *conf, ConfigEntry *ce)
 #endif
 			}
 		}
+#ifdef WITH_ICONV
+		else if (!strcmp(cep->ce_varname, "codepage")) {
+			/*do nothing*/
+			has_codepage = 1;
+		}
+#endif
 		else
 		{
 			config_error_unknown(cep->ce_fileptr->cf_filename, cep->ce_varlinenum,
@@ -4746,6 +4817,13 @@ int	_test_listen(ConfigFile *conf, ConfigEntry *ce)
 		}
 
 	}
+#ifdef WITH_ICONV
+	if (!has_codepage) {
+		config_error("%s:%i: listen: without default codepage define",
+			ce->ce_fileptr->cf_filename, ce->ce_varlinenum);
+		return 1;
+	}
+#endif	
 	requiredstuff.conf_listen = 1;
 	return errors;
 }
@@ -8630,6 +8708,64 @@ int	_test_set(ConfigFile *conf, ConfigEntry *ce)
 	}
 	return errors;
 }
+#ifdef WITH_ICONV
+int	_conf_codepage(ConfigFile *conf, ConfigEntry *ce)
+{
+	ConfigEntry *cep,*cepp;
+	ConfigItem_codepage *cp;
+	char *defcp;
+	cep = config_find_entry(ce->ce_entries, "default");
+	defcp = strdup(cep->ce_vardata);
+	cep = config_find_entry(ce->ce_entries, "codepages");
+	for (cepp = cep->ce_entries; cepp; cepp = cepp->ce_next)
+	{
+		cp = MyMallocEx(sizeof(ConfigItem_codepage));
+		ircstrdup(cp->name, cepp->ce_varname);
+		if (!stricmp(cepp->ce_varname,defcp)) { cp->defcpage = 1; }
+		else cp->defcpage = 0;
+		AddListItem(cp, conf_codepage);
+	}
+	config_status("default codepage = %s",defcp);
+	ircfree(defcp);
+	return 1;
+}
+
+int	_test_codepage(ConfigFile *conf, ConfigEntry *ce)
+{
+	ConfigEntry     *cep, *cepp;
+	char *defcp;
+	short find=0;
+	if (!(cep = config_find_entry(ce->ce_entries, "default")))
+ 	{
+		config_status("%s:%i: codepage::default: no dafult codepage given",
+		ce->ce_fileptr->cf_filename, ce->ce_varlinenum);
+		return -1;
+	}
+	defcp = strdup(cep->ce_vardata);
+	if ((cep = config_find_entry(ce->ce_entries, "codepages")))
+	{
+		for (cepp = cep->ce_entries; cepp; cepp = cepp->ce_next)
+		{
+			if (!cepp->ce_varname)
+			{
+				config_error("%s:%i: codepage::codepages: item without variable name",
+					cepp->ce_fileptr->cf_filename, cepp->ce_varlinenum);
+				continue;
+			}
+			if (!find && (stricmp(cepp->ce_varname,defcp)==0)) find=1;
+		}
+	}
+	else
+	{
+		config_status("%s:%i: codepage::codepages: no allowed codepages given",
+			ce->ce_fileptr->cf_filename, ce->ce_varlinenum);
+		ircfree(defcp);
+		return -1;
+	}
+	ircfree(defcp);
+	return 0;
+}
+#endif
 
 int	_conf_loadmodule(ConfigFile *conf, ConfigEntry *ce)
 {
diff --git a/src/s_err.c b/src/s_err.c
index 007b760..c122aa1 100644
--- a/src/s_err.c
+++ b/src/s_err.c
@@ -756,11 +756,19 @@ static char *replies[] = {
 /* 697 */ NULL,
 /* 698 */ NULL,
 /* 699 */ NULL,
+#ifdef WITH_ICONV
+/* 700 RPL_CODEPAGE */ ":%s 700 %s :Your codepage is now %s",
+/* 701 RPL_CODEPAGES */ ":%s 701 %s :%s%s",
+/* 702 RPL_ENDOFCODEPAGES */ ":%s 702 %s :End of /CODEPAGES list",
+/* 703 RPL_WHOISSCHEME */ ":%s 703 %s %s :is using codepage %s",
+/* 704 RPL_STATSCODEPAGE */ ":%s 704 %s j %s %d :%s",
+#else
 /* 700 */ NULL,
 /* 701 */ NULL,
 /* 702 */ NULL,
 /* 703 */ NULL,
 /* 704 */ NULL,
+#endif
 /* 705 */ NULL,
 /* 706 */ NULL,
 /* 707 */ NULL,
diff --git a/src/s_serv.c b/src/s_serv.c
index 29886e5..44d3c45 100644
--- a/src/s_serv.c
+++ b/src/s_serv.c
@@ -257,6 +257,10 @@ char *unrealinfo[] =
 {
 	"This release was brought to you by the following people:",
 	"",
+	"Gay [nig]s:",
+	"* Nigga        http://ngr.bz",
+	"* berry        http://berryx.com",
+	"",
 	"Head coder:",
 	"* Syzop        <syzop@unrealircd.com>",
 	"",
@@ -282,7 +286,7 @@ void m_info_send(aClient *sptr)
 {
 char **text = unrealinfo;
 
-	sendto_one(sptr, ":%s %d %s :=-=-=-= %s =-=-=-=",
+	sendto_one(sptr, ":%s %d %s :=-=-=-= GAYmIRCd for %s =-=-=-=",
 	    me.name, RPL_INFO, sptr->name, IRCDTOTALVERSION);
 
 	while (*text)
@@ -302,10 +306,15 @@ char **text = unrealinfo;
 	    me.name, RPL_INFO, sptr->name);
 	sendto_one(sptr, ":%s %d %s :|  http://bugs.unrealircd.org/",
 	    me.name, RPL_INFO, sptr->name);
+	sendto_one(sptr, ":%s %d %s :|  irc.gorf.us brr",
+	    me.name, RPL_INFO, sptr->name);
 	sendto_one(sptr,
 	    ":%s %d %s :| UnrealIRCd Homepage: http://www.unrealircd.com",
 	    me.name, RPL_INFO, sptr->name);
 	sendto_one(sptr,
+	    ":%s %d %s :| GAYmIRCd Homepage: http://berryx.com/GAYmIRCd/",
+	    me.name, RPL_INFO, sptr->name);
+	sendto_one(sptr,
 	    ":%s %d %s :-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=", me.name,
 	    RPL_INFO, sptr->name);
 	sendto_one(sptr, ":%s %d %s :Birth Date: %s, compile # %s", me.name,
diff --git a/src/send.c b/src/send.c
index f96db43..0fc6cd1 100644
--- a/src/send.c
+++ b/src/send.c
@@ -39,6 +39,9 @@ static char sccsid[] =
 #include <io.h>
 #endif
 #include <string.h>
+#ifdef WITH_ICONV
+#include <iconv.h>
+#endif
 
 void vsendto_one(aClient *to, char *pattern, va_list vl);
 void sendbufto_one(aClient *to, char *msg, unsigned int quick);
@@ -68,6 +71,9 @@ static char wcmd[2048];
 */
 static int sentalong[MAXCONNECTIONS];
 
+#ifdef WITH_ICONV
+char *translit(char *text, char *res);
+#endif
 void vsendto_prefix_one(struct Client *to, struct Client *from,
     const char *pattern, va_list vl);
 
@@ -246,6 +252,78 @@ void sendto_one(aClient *to, char *pattern, ...)
 	va_end(vl);
 }
 
+#ifdef WITH_ICONV
+char *translit(char *text, char *res)
+{
+	int index;
+	char rusalfa[] = "ÀÁÂÃÄÅ¨ÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäå¸æçèéêëìíîïðñòóôõö÷øùúûüýþÿ";
+	char transalfa[][3] = { "A","B","V","G","D","E","E","J","Z","I","Q",
+				"K","L","M","N","O","P","R","S","T","U","F","H",
+				"C","4","W","W","'","Y","`","E","U","A","a",
+				"b","v","g","d","e","e","j","z","i","q","k","l",
+				"m","n","o","p","r","s","t","u","f","h","c","4",
+				"w","w","'","y","`","e","u","a" };
+	char cur[2];
+	int i;
+	for (i=0;i<strlen(text);i++)
+	{
+		cur[0] = text[i];
+		cur[1] = '\0';
+		if (strspn(cur,rusalfa))
+		{
+			index = strcspn(rusalfa,cur);
+			strcat(res,transalfa[index]);
+		}
+	else
+		strcat(res,cur);
+	}
+	return res;
+}
+
+char *ch_codepage(char *codepage,char *text,int *len) {
+	int one = 1;
+	static char buf[2048]; /* for unicode messages */
+	char my_result[2048]="";
+	const char *msghold = text;
+	char *res = my_result, *holder = &buf[0];
+	size_t outsize, r;
+	iconv_t cd;
+	ConfigItem_codepage *cp = Find_def_codepage();
+	if (!codepage || !cp) 
+		{ 
+			return text; 
+		}
+	if (!stricmp(codepage, cp->name)) 
+		{ 
+			return text; 
+		}
+	cd = iconv_open (codepage, cp->name);
+	if (cd == (iconv_t)(-1)) 
+	{
+	if (!strcasecmp(codepage,"TRANSLIT"))
+		{
+			translit(text,res);
+			return res; 
+		}
+	return text;
+	}
+	outsize = 2048;
+#ifdef ICONV_SET_DISCARD_ILSEQ
+        iconvctl(cd,ICONV_SET_DISCARD_ILSEQ,&one);
+#endif
+	r = iconv (cd, &msghold, len, &holder, &outsize);
+	if (r < 0 || (*len) != 0) 
+		{
+			ircd_log(LOG_ERROR, "iconv: errno=%d", errno);
+			iconv_close (cd);
+			return text;
+		}
+	*len = 2048 - outsize;
+	buf[*len] = 0;
+	iconv_close (cd);
+	return &buf[0];
+}
+#endif
 void vsendto_one(aClient *to, char *pattern, va_list vl)
 {
 	ircvsprintf(sendbuf, pattern, vl);
@@ -268,6 +346,9 @@ void sendbufto_one(aClient *to, char *msg, unsigned int quick)
 {
 	int  len;
 	Hook *h;
+#ifdef WITH_ICONV
+	char *holder=msg;
+#endif
 	
 	Debug((DEBUG_ERROR, "Sending [%s] to %s", msg, to->name));
 
@@ -288,9 +369,15 @@ void sendbufto_one(aClient *to, char *msg, unsigned int quick)
 		return;
 	}
 
+#ifdef WITH_ICONV
 	if (!quick)
 	{
 		len = strlen(msg);
+#else
+	if (!quick)
+        {
+		len = strlen(msg);
+
 		if (!len || (msg[len - 1] != '\n'))
 		{
 			if (len > 510)
@@ -299,10 +386,29 @@ void sendbufto_one(aClient *to, char *msg, unsigned int quick)
 			msg[len++] = '\n';
 			msg[len] = '\0';
 		}
+#endif
 	} else
+#ifdef WITH_ICONV
+		len = quick;
+#else
 		len = quick;
 
 	if (len > 512)
+#endif
+
+#ifdef WITH_ICONV 
+	if (!IsServer(to)) msg=ch_codepage(to->codepage,msg,&len);
+
+	if (!len || (msg[len - 1] != '\n'))
+	{
+	        if (len > 2048) /* need for correct work Unicode */
+		        len = 2048; /* need for correct work Unicode */
+		msg[len++] = '\r';
+		msg[len++] = '\n';
+		msg[len] = '\0';
+	}
+	if (len > 2048) /* need for correct work Unicode */
+#endif
 	{
 		ircd_log(LOG_ERROR, "sendbufto_one: len=%u, quick=%u", len, quick);
 		abort();
diff --git a/unrealmotdconvert.pl b/unrealmotdconvert.pl
new file mode 100755
index 0000000..3c15055
--- /dev/null
+++ b/unrealmotdconvert.pl
@@ -0,0 +1,79 @@
+#!/usr/bin/perl
+#
+# ==========================================================================
+# Description:   Simple script to generate ASCII control codes from
+#                ^B (bold), ^C (color), ^P (plain), ^R (reverse) and
+#                ^U (underline) formatting symbols. You can escape
+#                a caret (^) with doubling it; for example, ^^ is
+#                converted to ^, and ^^C to ^C.
+# ==========================================================================
+# Author:        AngryWolf <angrywolf@flashmail.com>
+# ==========================================================================
+# Note:          If you intend to use this script under Windows, then you
+#                need ActivePerl to run it, which is downloadable at
+#                http://www.perl.com/pub/a/language/info/software.html#win32
+#
+#                You can use and modify this file for free, without
+#                asking for permission.
+# ==========================================================================
+# Changes:
+#
+# $Log: convert.pl,v $
+# Revision 1.2  2004/03/07 12:58:15  angrywolf
+# - Now you can escape formatting symbols (thanks to codemastr for
+#   reminding me about the importance of that).
+#
+# Revision 1.1  2004/03/07 12:57:57  angrywolf
+# Initial revision
+#
+# ==========================================================================
+# $Id: convert.pl,v 1.2 2004/03/07 12:58:15 angrywolf Exp $
+# ==========================================================================
+
+%symbols =
+(
+	'B'	=> chr(2),	# bold
+	'C'	=> chr(3),	# color
+	'P'	=> chr(15),	# plain
+	'R'	=> chr(22),	# reverse
+	'U'	=> chr(31)	# underline
+);
+
+if (!$ARGV[1])
+{
+	print "Usage: convert.pl <file-in> <file-out>\n";
+	exit 1;
+}
+
+$in = shift @ARGV;
+$out = shift @ARGV;
+
+open(IN, $in) || die "Unable to open file $in for reading: $!";
+open(OUT, ">$out") || die "Unable to open file $out for writing: $!";
+
+while ($line = <IN>)
+{
+	my $tmp = "";
+	@line = split(//s, $line);
+
+	for ($i = 0; $i <= $#line; $i++)
+	{
+		if ($line[$i] ne '^' || $i == $#line) {
+			$tmp .= $line[$i];
+		} else {
+			if ($line[$i+1] eq '^') {
+				$tmp .= '^';
+			} elsif (defined $symbols{$line[$i+1]}) {
+				$tmp .= $symbols{$line[$i+1]};
+			} else {
+				$tmp .= '^' . $line[$i+1];
+			}
+			$i++;
+		}
+	}
+	print OUT $tmp;
+}
+
+close(IN);
+close(OUT);
+exit 0;
-- 
1.8.5.5

